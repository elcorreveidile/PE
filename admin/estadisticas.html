<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadisticas | Panel de Administracion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .admin-header { background: linear-gradient(135deg, #c53030, #9b2c2c); }
        .admin-badge { background: #c53030; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem; }
        .stat-card { text-align: center; padding: 2rem; }
        .stat-value { font-size: 3rem; font-weight: 700; line-height: 1; }
        .stat-label { color: var(--text-secondary); margin-top: 0.5rem; }
        .chart-bar { height: 20px; background: var(--primary-light); border-radius: 4px; margin: 0.5rem 0; transition: width 0.5s ease; }
        .chart-row { display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
        .chart-label { width: 120px; font-size: 0.875rem; }
        .chart-container { flex: 1; margin: 0 1rem; }
        .chart-value { width: 60px; text-align: right; font-weight: 600; }
        .ranking-item { display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .ranking-position { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 1rem; }
        .ranking-1 { background: #ffd700; color: #000; }
        .ranking-2 { background: #c0c0c0; color: #000; }
        .ranking-3 { background: #cd7f32; color: #fff; }
        .ranking-other { background: var(--bg-light); color: var(--text-secondary); }
    </style>
</head>
<body>
    <header class="header admin-header">
        <div class="header-main">
            <div class="container">
                <a href="../index.html" class="logo">
                    <div class="logo-icon">C2</div>
                    <div class="logo-text">
                        <span class="logo-title">Panel de Administracion <span class="admin-badge">ADMIN</span></span>
                        <span class="logo-subtitle">CLM - UGR</span>
                    </div>
                </a>
                <nav class="nav-main"><a href="../index.html">Ver curso</a><a href="../sesiones/index.html">Sesiones</a></nav>
                <div class="nav-auth"></div>
            </div>
        </div>
    </header>

    <main class="section">
        <div class="container">
            <div class="page-with-sidebar">
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <h4 class="sidebar-title">Administracion</h4>
                        <ul class="sidebar-nav">
                            <li><a href="index.html">Panel principal</a></li>
                            <li><a href="estudiantes.html">Estudiantes</a></li>
                            <li><a href="correcciones.html">Correcciones</a></li>
                            <li><a href="notificaciones.html">Notificaciones</a></li>
                            <li><a href="tareas.html">Gestion de tareas</a></li>
                            <li><a href="estadisticas.html" class="active">Estadisticas</a></li>
                            <li><a href="comparacion.html">Comparacion</a></li>
                            <li><a href="rubricas.html">ðŸ“Š RÃºbricas</a></li>
                            <li><a href="boletines.html">ðŸ“‹ Boletines</a></li>
                        </ul>
                    </div>
                    <div class="sidebar-section">
                        <button onclick="PE.Auth.logout()" class="btn btn-outline btn-block">Cerrar sesion</button>
                    </div>
                </aside>

                <div class="main-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl);">
                        <div>
                            <h1 style="margin-bottom: 0.25rem;">Estadisticas del curso</h1>
                            <p class="text-secondary mb-0">Metricas y analisis del progreso general</p>
                        </div>
                        <button class="btn btn-outline" onclick="exportStats('csv')" title="Exportar a CSV">ðŸ“Š CSV</button>
                        <button class="btn btn-outline" onclick="exportStats('xlsx')" title="Exportar a Excel">ðŸ“ˆ Excel</button>
                    </div>

                    <!-- Estadisticas principales -->
                    <div class="sessions-grid mb-4" style="grid-template-columns: repeat(5, 1fr);">
                        <div class="card stat-card">
                            <span class="stat-value text-primary" id="stat-students">0</span>
                            <p class="stat-label">Estudiantes matriculados</p>
                        </div>
                        <div class="card stat-card">
                            <span class="stat-value" style="color: var(--success-color);" id="stat-submissions">0</span>
                            <p class="stat-label">Total de entregas</p>
                        </div>
                        <div class="card stat-card">
                            <span class="stat-value" style="color: var(--accent-color);" id="stat-graded">0</span>
                            <p class="stat-label">Entregas calificadas</p>
                        </div>
                        <div class="card stat-card">
                            <span class="stat-value" style="color: var(--warning-color);" id="stat-avg-grade">-</span>
                            <p class="stat-label">Nota media curso</p>
                        </div>
                        <div class="card stat-card">
                            <span class="stat-value text-primary" id="stat-words">0</span>
                            <p class="stat-label">Palabras escritas</p>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                        <!-- Progreso del curso -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Progreso del curso</h3>
                            </div>
                            <div class="card-body">
                                <div style="text-align: center; margin-bottom: 2rem;">
                                    <div style="font-size: 4rem; font-weight: 700; color: var(--primary-color);" id="course-progress">0%</div>
                                    <p class="text-secondary">del curso completado</p>
                                </div>
                                <div>
                                    <div class="chart-row">
                                        <span class="chart-label">Sesiones</span>
                                        <div class="chart-container">
                                            <div class="chart-bar" id="bar-sessions" style="width: 0%;"></div>
                                        </div>
                                        <span class="chart-value" id="val-sessions">0/27</span>
                                    </div>
                                    <div class="chart-row">
                                        <span class="chart-label">Temas</span>
                                        <div class="chart-container">
                                            <div class="chart-bar" id="bar-themes" style="width: 0%; background: var(--success-color);"></div>
                                        </div>
                                        <span class="chart-value" id="val-themes">0/11</span>
                                    </div>
                                    <div class="chart-row">
                                        <span class="chart-label">Talleres</span>
                                        <div class="chart-container">
                                            <div class="chart-bar" id="bar-workshops" style="width: 0%; background: var(--accent-color);"></div>
                                        </div>
                                        <span class="chart-value" id="val-workshops">0/4</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estado de correcciones -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Estado de correcciones</h3>
                            </div>
                            <div class="card-body">
                                <div style="display: flex; justify-content: center; gap: 3rem; margin-bottom: 2rem;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 3rem; font-weight: 700; color: var(--success-color);" id="stat-reviewed">0</div>
                                        <p class="text-secondary">Corregidas</p>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 3rem; font-weight: 700; color: var(--warning-color);" id="stat-pending">0</div>
                                        <p class="text-secondary">Pendientes</p>
                                    </div>
                                </div>
                                <div class="progress" style="height: 30px; border-radius: 15px;">
                                    <div class="progress-bar" id="progress-reviewed" style="width: 0%; background: var(--success-color);"></div>
                                </div>
                                <p class="text-secondary text-center mt-2" id="correction-rate">0% de entregas corregidas</p>
                            </div>
                        </div>
                    </div>

                    <!-- Entregas por sesion -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h3 class="card-title">Entregas por sesion</h3>
                        </div>
                        <div class="card-body" id="sessions-chart">
                            <div class="loader"></div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-top: var(--spacing-lg);">
                        <!-- Ranking de estudiantes -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Estudiantes mas activos</h3>
                            </div>
                            <div class="card-body" id="student-ranking">
                                <div class="loader"></div>
                            </div>
                        </div>

                        <!-- Distribucion de notas -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Distribucion de notas</h3>
                            </div>
                            <div class="card-body" id="grade-distribution">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Distribucion por nivel -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h3 class="card-title">Distribucion por nivel</h3>
                        </div>
                        <div class="card-body" id="level-distribution">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom" style="border:none;padding-top:0;">
                <span>&copy; 2026 Javier Benitez Lainez | CLM - UGR</span>
            </div>
        </div>
    </footer>

    <script>
        window.PE_CONFIG = {
            API_URL: 'https://produccion-escrita-c2-api-production.up.railway.app'
        };
    </script>
    <script src="../js/config.js"></script>
<script src="../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await PE.Auth.checkSession();
            if (!user || user.role !== 'admin') {
                const basePath = window.location.pathname.includes('/PE/') ? '/PE' : '';
                window.location.href = basePath + '/auth/login.html';
                return;
            }

            const API = PE.API;
            const CONFIG = window.CONFIG || { USE_API: false };

            try {
                await API.ensureAvailability();
                CONFIG.USE_API = true;
            } catch (e) {
                console.error('API no disponible:', e);
            }

            // Obtener datos
            let users = [];
            let submissions = [];
            let rubricMaxById = {};

            try {
                if (CONFIG.USE_API) {
                    users = await API.get('/users');
                    submissions = await PE.Submissions.getAll();
                } else {
                    users = JSON.parse(localStorage.getItem('pe_c2_users') || '[]');
                    submissions = await PE.Submissions.getAll();
                }
            } catch (e) {
                console.error('Error cargando datos:', e);
                users = [];
                submissions = [];
            }

            submissions = Array.isArray(submissions) ? submissions : [];
            const students = users.filter(u => (u.role || 'student') !== 'admin');
            const sessions = PE.CourseData.sessions;
            const progress = PE.CourseData.getCourseProgress();
            const today = PE.CourseData.getTodayDate ? PE.CourseData.getTodayDate() : new Date();

            const normStatus = (v) => String(v || '').trim().toLowerCase();
            const reviewed = submissions.filter(s => normStatus(s.status) === 'reviewed');
            const pending = submissions.filter(s => normStatus(s.status) === 'pending');
            const totalWords = submissions.reduce((sum, s) => sum + (s.word_count || s.wordCount || 0), 0);
            const avgWords = submissions.length > 0 ? Math.round(totalWords / submissions.length) : 0;

            // Cargar rÃºbricas (para normalizar notas a escala /10 cuando hay rÃºbrica)
            try {
                const rubrics = await API.get('/rubrics');
                (Array.isArray(rubrics) ? rubrics : []).forEach(r => {
                    if (r && r.id) rubricMaxById[String(r.id)] = parseFloat(r.maxPoints) || 0;
                });
            } catch (e) {
                console.warn('[Stats] No se pudieron cargar rÃºbricas:', e?.message || e);
            }

            const qualitativeTo10 = (g) => {
                const v = String(g || '').trim().toLowerCase();
                if (!v) return null;
                if (v === 'excelente') return 9.5;
                if (v === 'muy bien') return 8.5;
                if (v === 'bien') return 7.5;
                if (v === 'suficiente') return 6.0;
                if (v === 'necesita mejorar') return 4.5;
                return null;
            };

            const parseJsonMaybe = (value) => {
                if (!value) return null;
                if (typeof value === 'object') return value;
                if (typeof value !== 'string') return null;
                try { return JSON.parse(value); } catch { return null; }
            };

            const sumCriterionScores = (scores) => {
                const obj = parseJsonMaybe(scores);
                if (!obj || typeof obj !== 'object') return null;
                let total = 0;
                let any = false;
                for (const v of Object.values(obj)) {
                    const n = parseFloat(v);
                    if (!Number.isNaN(n)) {
                        total += n;
                        any = true;
                    }
                }
                return any ? total : null;
            };

            // Nota en escala /10 si se puede calcular
            const gradeValue10 = (s) => {
                const rubricId = s.rubricId ?? s.rubric_id;
                const maxPoints = rubricId ? (rubricMaxById[String(rubricId)] || 0) : 0;

                const numeric = parseFloat(s.numericGrade ?? s.numeric_grade);
                if (!Number.isNaN(numeric)) {
                    return maxPoints > 0 ? (numeric / maxPoints) * 10 : numeric;
                }

                const scoresTotal = sumCriterionScores(s.criterionScores ?? s.criterion_scores);
                if (scoresTotal !== null) {
                    return maxPoints > 0 ? (scoresTotal / maxPoints) * 10 : scoresTotal;
                }

                const q = qualitativeTo10(s.grade);
                if (q !== null) return q;

                // Formato texto "8/10" (compat)
                if (s.grade) {
                    const match = String(s.grade).trim().match(/^(\d+\.?\d*)/);
                    if (match) return parseFloat(match[1]);
                }
                return null;
            };

            const gradedReviewed = reviewed
                .map(s => gradeValue10(s))
                .filter(v => v !== null && !Number.isNaN(v));

            const averageGrade = gradedReviewed.length > 0
                ? (gradedReviewed.reduce((sum, v) => sum + v, 0) / gradedReviewed.length).toFixed(1)
                : '-';

            // Estadisticas principales
            document.getElementById('stat-students').textContent = students.length;
            document.getElementById('stat-submissions').textContent = submissions.length;
            document.getElementById('stat-graded').textContent = gradedReviewed.length;
            document.getElementById('stat-avg-grade').textContent = averageGrade;
            document.getElementById('stat-words').textContent = totalWords.toLocaleString('es-ES');

            // Progreso del curso
            document.getElementById('course-progress').textContent = progress.percentage + '%';
            document.getElementById('bar-sessions').style.width = progress.percentage + '%';
            document.getElementById('val-sessions').textContent = progress.completed + '/27';

            const themesCompleted = Math.floor(progress.completed / 2);
            document.getElementById('bar-themes').style.width = Math.round(themesCompleted / 11 * 100) + '%';
            document.getElementById('val-themes').textContent = themesCompleted + '/11';

            const workshopsCompleted = sessions.filter(s => {
                const sessionDate = PE.CourseData.getSessionDate ? PE.CourseData.getSessionDate(s.date) : new Date(s.date);
                return s.workshop && sessionDate < today;
            }).length;
            document.getElementById('bar-workshops').style.width = Math.round(workshopsCompleted / 4 * 100) + '%';
            document.getElementById('val-workshops').textContent = workshopsCompleted + '/4';

            // Estado de correcciones
            document.getElementById('stat-reviewed').textContent = reviewed.length;
            document.getElementById('stat-pending').textContent = pending.length;
            const correctionRate = submissions.length > 0 ? Math.round(reviewed.length / submissions.length * 100) : 0;
            document.getElementById('progress-reviewed').style.width = correctionRate + '%';
            document.getElementById('correction-rate').textContent = correctionRate + '% de entregas corregidas';

            // Entregas por sesion
            const maxSubmissions = Math.max(...sessions.map(s => submissions.filter(sub => sub.session_id == s.id || sub.sessionId == s.id).length), 1);
            document.getElementById('sessions-chart').innerHTML = sessions.map(session => {
                const count = submissions.filter(s => s.session_id == session.id || s.sessionId == session.id).length;
                const width = (count / maxSubmissions) * 100;
                return `
                    <div class="chart-row">
                        <span class="chart-label">S${session.id}</span>
                        <div class="chart-container">
                            <div class="chart-bar" style="width: ${width}%;"></div>
                        </div>
                        <span class="chart-value">${count}</span>
                    </div>
                `;
            }).join('');

            // Ranking de estudiantes por nota (escala /10)
            const studentStats = students.map(s => {
                const studentSubmissions = submissions.filter(sub => String(sub.user_id || sub.userId) === String(s.id));
                const studentReviewed = studentSubmissions.filter(sub => (sub.status || '').toString() === 'reviewed');
                const studentGrades = studentReviewed
                    .map(sub => gradeValue10(sub))
                    .filter(v => v !== null && !Number.isNaN(v));
                const avgGrade = studentGrades.length > 0
                    ? studentGrades.reduce((sum, v) => sum + v, 0) / studentGrades.length
                    : null;
                
                return {
                    ...s,
                    submissions: studentSubmissions.length,
                    gradedSubmissions: studentGrades.length,
                    words: studentSubmissions.reduce((sum, sub) => sum + (sub.word_count || sub.wordCount || 0), 0),
                    avgGrade: avgGrade
                };
            }).filter(s => s.avgGrade !== null).sort((a, b) => b.avgGrade - a.avgGrade);

            if (studentStats.length === 0) {
                document.getElementById('student-ranking').innerHTML = '<p class="text-secondary text-center">No hay estudiantes con notas.</p>';
            } else {
                document.getElementById('student-ranking').innerHTML = studentStats.slice(0, 5).map((s, i) => `
                    <div class="ranking-item">
                        <div class="ranking-position ${i < 3 ? 'ranking-' + (i + 1) : 'ranking-other'}">${i + 1}</div>
                        <div style="flex: 1;">
                            <strong>${PE.Utils.escapeHtml(s.name)}</strong>
                            <p class="text-secondary mb-0" style="font-size: 0.8rem;">${s.submissions} entregas (${s.gradedSubmissions} calificadas)</p>
                        </div>
                        <div class="badge badge-primary">${s.avgGrade.toFixed(1)}</div>
                    </div>
                `).join('');
            }

            // DistribuciÃ³n de notas (escala /10)
            const gradeRanges = {
                'Sobresaliente (9-10)': gradedReviewed.filter(v => v >= 9).length,
                'Notable (7-8.9)': gradedReviewed.filter(v => v >= 7 && v < 9).length,
                'Bien (6-6.9)': gradedReviewed.filter(v => v >= 6 && v < 7).length,
                'Suficiente (5-5.9)': gradedReviewed.filter(v => v >= 5 && v < 6).length,
                'Insuficiente (<5)': gradedReviewed.filter(v => v < 5).length
            };

            const maxGradeCount = Math.max(...Object.values(gradeRanges), 1);
            const totalGraded = gradedReviewed.length || 1;

            const gradeDistHtml = Object.entries(gradeRanges).map(([range, count]) => {
                const width = (count / maxGradeCount) * 100;
                const percentage = (count / totalGraded * 100).toFixed(0);
                const colors = {
                    'Sobresaliente (9-10)': 'var(--success-color)',
                    'Notable (7-8.9)': 'var(--primary-color)',
                    'Bien (6-6.9)': 'var(--accent-color)',
                    'Suficiente (5-5.9)': 'var(--warning-color)',
                    'Insuficiente (<5)': 'var(--danger-color)'
                };
                return `
                    <div class="chart-row">
                        <span class="chart-label">${range}</span>
                        <div class="chart-container">
                            <div class="chart-bar" style="width: ${width}%; background: ${colors[range]};"></div>
                        </div>
                        <span class="chart-value">${count} (${percentage}%)</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('grade-distribution').innerHTML = gradeDistHtml;

            // Distribucion por nivel
            const levels = { 'B2': 0, 'C1': 0, 'C2': 0 };
            students.forEach(s => {
                const raw = (s.level || 'C2').toString().trim().toUpperCase();
                const level = levels.hasOwnProperty(raw) ? raw : 'C2';
                levels[level]++;
            });

            const totalStudents = students.length || 1;
            document.getElementById('level-distribution').innerHTML = Object.entries(levels).map(([level, count]) => {
                const percentage = Math.round(count / totalStudents * 100);
                return `
                    <div class="chart-row">
                        <span class="chart-label"><strong>${level}</strong></span>
                        <div class="chart-container">
                            <div class="chart-bar" style="width: ${percentage}%; background: ${level === 'C2' ? 'var(--primary-color)' : level === 'C1' ? 'var(--success-color)' : 'var(--accent-color)'};"></div>
                        </div>
                        <span class="chart-value">${count} (${percentage}%)</span>
                    </div>
                `;
            }).join('');
        });

        async function exportStats(format) {
            try {
                const CONFIG = window.PE_CONFIG || {};
                const token = PE.Utils?.storage?.get('token') || localStorage.getItem('pe_c2_token');

                if (!token) {
                    throw new Error('No hay sesiÃ³n activa');
                }

                const response = await fetch(`${CONFIG.API_URL}/api/users/export/stats?format=${format}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Error al exportar estadÃ­sticas');
                }

                // Descargar archivo
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `estadisticas_${new Date().toISOString().split('T')[0]}.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                PE.UI.notify(`EstadÃ­sticas exportadas a ${format.toUpperCase()} correctamente`, 'success');
            } catch (error) {
                console.error('Error exportando:', error);
                PE.UI.notify(error.message || 'Error al exportar estadÃ­sticas', 'error');
            }
        }
    </script>
</body>
</html>
