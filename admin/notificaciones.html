<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificaciones | Panel Admin - Producci√≥n Escrita C2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .admin-header { background: linear-gradient(135deg, #c53030, #9b2c2c); }
        .notification-preview {
            background: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .recipient-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--bg-light);
            border-radius: 20px;
            font-size: 0.875rem;
            margin: 0.25rem;
        }
        .recipient-badge.active {
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <header class="header admin-header">
        <div class="header-main">
            <div class="container">
                <a href="../index.html" class="logo">
                    <div class="logo-icon">C2</div>
                    <div class="logo-text">
                        <span class="logo-title">Panel de Administraci√≥n</span>
                        <span class="logo-subtitle">CLM - UGR</span>
                    </div>
                </a>
                <nav class="nav-main"><a href="../index.html">Ver curso</a><a href="../sesiones/index.html">Sesiones</a></nav>
                <div class="nav-auth"></div>
            </div>
        </div>
    </header>

    <main class="section">
        <div class="container">
            <div class="page-with-sidebar">
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <h4 class="sidebar-title">Administraci√≥n</h4>
                        <ul class="sidebar-nav">
                            <li><a href="index.html">Panel principal</a></li>
                            <li><a href="estudiantes.html">Estudiantes</a></li>
                            <li><a href="correcciones.html">Correcciones</a></li>
                            <li><a href="notificaciones.html" class="active">Notificaciones</a></li>
                        </ul>
                    </div>
                    <div class="sidebar-section">
                        <button onclick="PE.Auth.logout()" class="btn btn-outline btn-block">Cerrar sesi√≥n</button>
                    </div>
                </aside>

                <div class="main-content">
                    <h1>üì¢ Sistema de Notificaciones</h1>
                    <p class="text-secondary mb-4">Env√≠a mensajes y comunicados a los estudiantes del curso</p>

                    <!-- Estad√≠sticas -->
                    <div class="sessions-grid mb-4" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" id="stat-total">0</h3>
                                <p class="text-secondary mb-0">Total Estudiantes</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 style="color: var(--success-color);" id="stat-active">0</h3>
                                <p class="text-secondary mb-0">Activos (con entregas)</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 style="color: var(--warning-color);" id="stat-inactive">0</h3>
                                <p class="text-secondary mb-0">Inactivos (sin entregas)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario de env√≠o -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h3 class="mb-3">üìù Nueva Notificaci√≥n</h3>

                            <div class="form-group">
                                <label class="form-label">T√≠tulo de la notificaci√≥n</label>
                                <input type="text" id="notif-title" class="form-control" placeholder="Ej: Recordatorio de entrega - Sesi√≥n 5">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Mensaje</label>
                                <textarea id="notif-message" class="form-control" rows="5" placeholder="Escribe aqu√≠ el mensaje para los estudiantes..."></textarea>
                                <small class="text-secondary">Puedes usar texto plano. El mensaje se enviar√° tal como lo escribas.</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Destinatarios</label>
                                <div class="mb-2">
                                    <label class="radio-label">
                                        <input type="radio" name="target" value="all" checked>
                                        <span>üë• Todos los estudiantes</span>
                                    </label>
                                </div>
                                <div class="mb-2">
                                    <label class="radio-label">
                                        <input type="radio" name="target" value="active">
                                        <span>‚úÖ Estudiantes activos (han entregado al menos una tarea)</span>
                                    </label>
                                </div>
                                <div class="mb-2">
                                    <label class="radio-label">
                                        <input type="radio" name="target" value="inactive">
                                        <span>‚ö†Ô∏è Estudiantes inactivos (no han entregado nada)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Previsualizaci√≥n -->
                            <div class="notification-preview">
                                <h5 class="mb-2">üìã Previsualizaci√≥n:</h5>
                                <div id="preview-content" style="font-style: italic; color: var(--text-secondary);">
                                    Escribe un t√≠tulo y mensaje para ver la previsualizaci√≥n...
                                </div>
                            </div>

                            <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                                <button class="btn btn-primary" onclick="sendNotification()">
                                    üì§ Enviar Notificaci√≥n
                                </button>
                                <button class="btn btn-outline" onclick="clearForm()">
                                    üîÑ Limpiar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Historial reciente -->
                    <div class="card">
                        <div class="card-body">
                            <h3 class="mb-3">üìú Historial de Env√≠os Recientes</h3>
                            <div id="sent-history">
                                <p class="text-secondary">Cargando historial...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom" style="border:none;padding-top:0;">
                <span>&copy; 2026 Javier Ben√≠tez L√°inez | CLM - UGR</span>
            </div>
        </div>
    </footer>

    <script>
        window.PE_CONFIG = {
            API_URL: 'https://produccion-escrita-c2-api-production.up.railway.app'
        };
    </script>
    <script src="../js/app.js"></script>
    <script>
        let allUsers = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const user = PE.Auth.getCurrentUser();
            if (!user || user.role !== 'admin') {
                window.location.href = '../auth/login.html';
                return;
            }

            // Cargar datos
            await loadData();

            // Configurar listeners para previsualizaci√≥n
            setupPreviewListeners();

            // Cargar historial
            loadHistory();
        });

        async function loadData() {
            try {
                allUsers = await PE.API.get('/users');
                allUsers = Array.isArray(allUsers) ? allUsers.filter(u => (u.role || 'student') !== 'admin') : [];

                const active = allUsers.filter(u => u.submissions_count > 0);
                const inactive = allUsers.filter(u => !u.submissions_count || u.submissions_count === 0);

                document.getElementById('stat-total').textContent = allUsers.length;
                document.getElementById('stat-active').textContent = active.length;
                document.getElementById('stat-inactive').textContent = inactive.length;

            } catch (error) {
                console.error('Error cargando datos:', error);
                PE.UI.notify('Error al cargar los datos', 'error');
            }
        }

        function setupPreviewListeners() {
            const titleInput = document.getElementById('notif-title');
            const messageInput = document.getElementById('notif-message');
            const preview = document.getElementById('preview-content');

            function updatePreview() {
                const title = titleInput.value.trim();
                const message = messageInput.value.trim();

                if (!title && !message) {
                    preview.innerHTML = 'Escribe un t√≠tulo y mensaje para ver la previsualizaci√≥n...';
                    preview.style.fontStyle = 'italic';
                    preview.style.color = 'var(--text-secondary)';
                    return;
                }

                preview.style.fontStyle = 'normal';
                preview.style.color = 'var(--text-color)';

                let html = '';
                if (title) {
                    html += `<h6 style="color: var(--primary-color); margin-bottom: 0.5rem;">${PE.Utils.escapeHtml(title)}</h6>`;
                }
                if (message) {
                    html += `<p style="margin-bottom: 0; white-space: pre-wrap;">${PE.Utils.escapeHtml(message)}</p>`;
                }

                // Obtener destinatarios seleccionados
                const target = document.querySelector('input[name="target"]:checked').value;
                let recipientText = 'Todos los estudiantes';
                if (target === 'active') recipientText = 'Estudiantes activos';
                if (target === 'inactive') recipientText = 'Estudiantes inactivos';

                html += `<div style="margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid #dee2e6;">
                    <small class="text-secondary">üì® Para: ${recipientText}</small>
                </div>`;

                preview.innerHTML = html;
            }

            titleInput.addEventListener('input', updatePreview);
            messageInput.addEventListener('input', updatePreview);

            document.querySelectorAll('input[name="target"]').forEach(radio => {
                radio.addEventListener('change', updatePreview);
            });
        }

        async function sendNotification() {
            const title = document.getElementById('notif-title').value.trim();
            const message = document.getElementById('notif-message').value.trim();
            const target = document.querySelector('input[name="target"]:checked').value;

            if (!title) {
                PE.UI.notify('El t√≠tulo es requerido', 'error');
                return;
            }

            if (!message) {
                PE.UI.notify('El mensaje es requerido', 'error');
                return;
            }

            if (title.length < 5) {
                PE.UI.notify('El t√≠tulo debe tener al menos 5 caracteres', 'error');
                return;
            }

            if (message.length < 10) {
                PE.UI.notify('El mensaje debe tener al menos 10 caracteres', 'error');
                return;
            }

            // Confirmar env√≠o
            const targetLabels = {
                'all': 'todos los estudiantes',
                'active': 'estudiantes activos',
                'inactive': 'estudiantes inactivos'
            };

            const confirmed = confirm(`¬øEnviar notificaci√≥n a ${targetLabels[target]}?\n\nT√≠tulo: ${title}\n\nEsta acci√≥n enviar√° una notificaci√≥n a cada estudiante y no se puede deshacer.`);

            if (!confirmed) return;

            try {
                const response = await PE.API.post('/admin/notifications/broadcast', {
                    title,
                    message,
                    target
                });

                if (response.message) {
                    PE.UI.notify(`‚úÖ ${response.message} (${response.recipients} destinatarios)`, 'success');
                    clearForm();
                    loadHistory();
                }

            } catch (error) {
                console.error('Error enviando notificaci√≥n:', error);
                PE.UI.notify('Error al enviar la notificaci√≥n', 'error');
            }
        }

        function clearForm() {
            document.getElementById('notif-title').value = '';
            document.getElementById('notif-message').value = '';
            document.querySelector('input[name="target"][value="all"]').checked = true;
            document.getElementById('preview-content').innerHTML = 'Escribe un t√≠tulo y mensaje para ver la previsualizaci√≥n...';
            document.getElementById('preview-content').style.fontStyle = 'italic';
            document.getElementById('preview-content').style.color = 'var(--text-secondary)';
        }

        async function loadHistory() {
            const container = document.getElementById('sent-history');

            try {
                // Obtener notificaciones recientes del sistema
                // Nota: El endpoint actual no devuelve historial de env√≠os, as√≠ que mostramos un mensaje
                container.innerHTML = `
                    <p class="text-secondary">
                        ‚ÑπÔ∏è Las notificaciones se env√≠an instant√°neamente a los estudiantes.
                        Los estudiantes pueden verlas en su panel personal.
                    </p>
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 0.5rem;">
                        <h6 style="margin-bottom: 0.5rem;">üí° Sugerencias de uso:</h6>
                        <ul style="margin: 0; padding-left: 1.25rem;">
                            <li>Recordatorios de entregas pendientes</li>
                            <li>Anuncios de cambios en el horario o ubicaci√≥n</li>
                            <li>Motivaci√≥n para estudiantes inactivos</li>
                            <li>Felicitaciones por progreso destacado</li>
                        </ul>
                    </div>
                `;

            } catch (error) {
                console.error('Error cargando historial:', error);
            }
        }
    </script>
</body>
</html>
