<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boletines de Notas | Panel Admin - Producci√≥n Escrita C2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .admin-header { background: linear-gradient(135deg, #c53030, #9b2c2c); }
        .report-card { border-left: 4px solid var(--primary-color); transition: all 0.3s ease; }
        .report-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .grade-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.5rem;
        }
        .grade-excellent { background: #28a745; color: white; }
        .grade-excellent p { color: rgba(255,255,255,0.9); }
        .grade-very-good { background: #1a365d; color: white; }
        .grade-very-good p { color: rgba(255,255,255,0.9); }
        .grade-good { background: #d69e2e; color: white; }
        .grade-good p { color: rgba(255,255,255,0.9); }
        .grade-sufficient { background: #ffc107; color: #333; }
        .grade-sufficient p { color: #333; }
        .grade-insufficient { background: #dc3545; color: white; }
        .grade-insufficient p { color: rgba(255,255,255,0.9); }
        .grade-none { background: #f7fafc; color: #4a5568; }
        .grade-none p { color: #4a5568; }
        .progress-chart { height: 8px; background: var(--bg-light); border-radius: 4px; overflow: hidden; }
        .progress-chart-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-secondary); }
        .empty-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <header class="header admin-header">
        <div class="header-main">
            <div class="container">
                <a href="../index.html" class="logo">
                    <div class="logo-icon">C2</div>
                    <div class="logo-text">
                        <span class="logo-title">Panel de Administraci√≥n</span>
                        <span class="logo-subtitle">CLM - UGR</span>
                    </div>
                </a>
                <nav class="nav-main"><a href="../index.html">Ver curso</a><a href="../sesiones/index.html">Sesiones</a></nav>
                <div class="nav-auth"></div>
            </div>
        </div>
    </header>

    <main class="section">
        <div class="container">
            <div class="page-with-sidebar">
                <aside class="sidebar no-print">
                    <div class="sidebar-section">
                        <h4 class="sidebar-title">Administraci√≥n</h4>
                        <ul class="sidebar-nav">
                            <li><a href="index.html">Panel principal</a></li>
                            <li><a href="estudiantes.html">Estudiantes</a></li>
                            <li><a href="correcciones.html">Correcciones</a></li>
                            <li><a href="notificaciones.html">Notificaciones</a></li>
                            <li><a href="asistencia.html">Asistencia QR</a></li>
                            <li><a href="tareas.html">Gesti√≥n de tareas</a></li>
                            <li><a href="estadisticas.html">Estad√≠sticas</a></li>
                            <li><a href="comparacion.html">Comparaci√≥n</a></li>
                            <li><a href="rubricas.html">üìä R√∫bricas</a></li>
                            <li><a href="boletines.html" class="active">üìã Boletines</a></li>
                        </ul>
                    </div>
                    <div class="sidebar-section">
                        <button onclick="PE.Auth.logout()" class="btn btn-outline btn-block">Cerrar sesi√≥n</button>
                    </div>
                </aside>

                <div class="main-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl);">
                        <div>
                            <h1 style="margin-bottom: 0.25rem;">Boletines de Notas</h1>
                            <p class="text-secondary mb-0">Reportes individuales y certificaciones</p>
                        </div>
                        <button class="btn btn-primary no-print" onclick="generateAllReports()">üìä Generar todos los boletines</button>
                    </div>

                    <!-- Filtros -->
                    <div class="card mb-4 no-print">
                        <div class="card-body">
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                                <input type="text" id="search-student" class="form-control" placeholder="üîç Buscar estudiante..." style="flex: 1; min-width: 250px;">
                                
                                <select id="filter-level" class="form-control form-select" style="width: auto;">
                                    <option value="">Todos los niveles</option>
                                    <option value="B2">Nivel B2</option>
                                    <option value="C1">Nivel C1</option>
                                    <option value="C2">Nivel C2</option>
                                </select>

                                <select id="filter-status" class="form-control form-select" style="width: auto;">
                                    <option value="">Todos los estados</option>
                                    <option value="completed">Completado</option>
                                    <option value="in-progress">En progreso</option>
                                </select>

                                <button class="btn btn-outline" onclick="resetFilters()">üîÑ Limpiar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de estudiantes -->
                    <div id="students-list"></div>

                    <!-- Modal del bolet√≠n -->
                    <div id="report-modal" style="display: none;"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer no-print">
        <div class="container">
            <div class="footer-bottom" style="border:none;padding-top:0;">
                <span>&copy; 2026 Javier Ben√≠tez L√°inez | CLM - UGR</span>
            </div>
        </div>
    </footer>

    <script>
        window.PE_CONFIG = {
            API_URL: 'https://produccion-escrita-c2-api-production.up.railway.app'
        };
    </script>
    <script src="../js/config.js"></script>
<script src="../js/app.js"></script>
    <script>
        let allStudents = [];
        let allSubmissions = [];
        let allUsers = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await PE.Auth.checkSession();
            if (!user || user.role !== 'admin') {
                window.location.href = '../auth/login.html';
                return;
            }

            await loadData();
            setupEventListeners();
            renderStudents();
        });

        async function loadData() {
            const container = document.getElementById('students-list');
            container.innerHTML = '<div class="loader"></div>';
            
            try {
                console.log('Cargando entregas...');
                allSubmissions = await PE.Submissions.getAll();
                allSubmissions = Array.isArray(allSubmissions) ? allSubmissions : [];
                console.log('Entregas cargadas:', allSubmissions.length);

                console.log('Cargando usuarios...');
                allUsers = await PE.API.get('/users');
                allUsers = Array.isArray(allUsers) ? allUsers.filter(u => (u.role || 'student') !== 'admin') : [];
                console.log('Usuarios cargados:', allUsers.length);

                // Calcular datos de estudiantes
                allStudents = allUsers.map(user => {
                    const userSubmissions = allSubmissions.filter(s =>
                        String(s.user_id || s.userId) === String(user.id)
                    );
                    const gradedSubmissions = userSubmissions.filter(s => {
                        const gradeNum = parseFloat(s.numeric_grade);
                        return !isNaN(gradeNum);
                    });

                    const avgGrade = gradedSubmissions.length > 0
                        ? gradedSubmissions.reduce((sum, s) => sum + parseFloat(s.numeric_grade || 0), 0) / gradedSubmissions.length
                        : null;

                    const totalWords = userSubmissions.reduce((sum, s) => 
                        sum + (s.word_count || s.wordCount || 0), 0
                    );

                    // Calcular progreso
                    const totalSessions = 27; // N√∫mero total de sesiones
                    const attendedSessions = new Set(userSubmissions.map(s => s.session_id || s.sessionId)).size;
                    const progressPercent = Math.round((attendedSessions / totalSessions) * 100);

                    return {
                        ...user,
                        submissions: userSubmissions.length,
                        gradedSubmissions: gradedSubmissions.length,
                        avgGrade,
                        totalWords,
                        progressPercent,
                        userSubmissions
                    };
                });
                
                console.log('Estudiantes procesados:', allStudents.length);
                renderStudents();
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                
                // Mostrar error en el UI
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <h3>Error al cargar los datos</h3>
                            <p class="text-secondary">${error.message}</p>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-outline" onclick="loadData()">üîÑ Reintentar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                PE.UI.notify(`Error: ${error.message}`, 'error');
            }
        }

        function setupEventListeners() {
            document.getElementById('search-student').addEventListener('input', 
                PE.Utils.debounce(renderStudents, 300)
            );
            document.getElementById('filter-level').addEventListener('change', renderStudents);
            document.getElementById('filter-status').addEventListener('change', renderStudents);
        }

        function resetFilters() {
            document.getElementById('search-student').value = '';
            document.getElementById('filter-level').value = '';
            document.getElementById('filter-status').value = '';
            renderStudents();
        }

        function renderStudents() {
            const searchTerm = document.getElementById('search-student').value.toLowerCase();
            const levelFilter = document.getElementById('filter-level').value;
            const statusFilter = document.getElementById('filter-status').value;

            let filtered = allStudents.filter(student => {
                if (searchTerm && !student.name.toLowerCase().includes(searchTerm)) return false;
                if (levelFilter && student.level !== levelFilter) return false;
                if (statusFilter === 'completed' && student.progressPercent < 80) return false;
                if (statusFilter === 'in-progress' && student.progressPercent >= 80) return false;
                return true;
            });

            const container = document.getElementById('students-list');

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>No se encontraron estudiantes</h3>
                            <p>Intenta ajustar los filtros de b√∫squeda</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map((student, index) => {
                const gradeClass = getGradeClass(student.avgGrade);
                const gradeText = student.avgGrade ? student.avgGrade.toFixed(1) : '-';
                const progressColor = student.progressPercent >= 80 ? 'var(--success-color)' :
                                    student.progressPercent >= 50 ? 'var(--accent-color)' : 'var(--warning-color)';

                return `
                    <div class="card mb-3 report-card">
                        <div class="card-body">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                                <div style="flex: 1; min-width: 300px;">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                        <h4 style="margin: 0;">${PE.Utils.escapeHtml(student.name)}</h4>
                                        <span class="badge badge-info">${student.level || 'C2'}</span>
                                    </div>
                                    <p class="text-secondary mb-2">${PE.Utils.escapeHtml(student.email)}</p>
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                        <span class="badge badge-primary">${student.submissions} entregas</span>
                                        <span class="badge badge-${student.gradedSubmissions > 0 ? 'success' : 'warning'}">
                                            ${student.gradedSubmissions} calificadas
                                        </span>
                                        <span class="badge badge-info">${student.totalWords.toLocaleString('es-ES')} palabras</span>
                                    </div>
                                </div>
                                <div style="text-align: center; min-width: 150px;">
                                    <div class="grade-badge ${gradeClass}">${gradeText}</div>
                                    <p class="text-secondary mb-0" style="font-size: 0.875rem;">Nota media</p>
                                </div>
                            </div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span class="text-secondary">Progreso del curso</span>
                                    <strong>${student.progressPercent}%</strong>
                                </div>
                                <div class="progress-chart">
                                    <div class="progress-chart-fill" style="width: ${student.progressPercent}%; background: ${progressColor};"></div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                                <button class="btn btn-sm btn-outline" onclick="viewReport('${student.id}')">üìã Ver bolet√≠n</button>
                                <button class="btn btn-sm btn-primary" onclick="printReport('${student.id}')">üñ®Ô∏è Imprimir</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getGradeClass(grade) {
            if (grade === null || grade === undefined || isNaN(grade)) return 'grade-none';
            if (grade >= 9) return 'grade-excellent';
            if (grade >= 7) return 'grade-very-good';
            if (grade >= 6) return 'grade-good';
            if (grade >= 5) return 'grade-sufficient';
            return 'grade-insufficient';
        }

        function viewReport(studentId) {
            console.log('viewReport called with studentId:', studentId);
            const student = allStudents.find(s => String(s.id) === String(studentId));
            if (!student) {
                console.error('Student not found:', studentId);
                PE.UI.notify('Estudiante no encontrado', 'error');
                return;
            }

            console.log('Student found:', student.name, 'Avg grade:', student.avgGrade);

            const gradeClass = getGradeClass(student.avgGrade);
            const gradeText = student.avgGrade ? student.avgGrade.toFixed(1) : '-';
            const today = new Date().toLocaleDateString('es-ES', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            const reportHtml = `
                <div id="report-content" style="max-width: 800px; margin: 0 auto; max-height: 70vh; overflow-y: auto;">
                    <!-- Cabecera del reporte -->
                    <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid var(--primary-color);">
                        <h2 style="margin: 0 0 0.5rem;">BOLET√çN DE CALIFICACIONES</h2>
                        <p class="text-secondary mb-0">Producci√≥n Escrita C2 - CLM UGR</p>
                        <p class="text-secondary mb-0"><strong>Fecha:</strong> ${today}</p>
                    </div>

                    <!-- Informaci√≥n del estudiante -->
                    <div style="background: var(--bg-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="margin: 0 0 1rem;">üë§ Datos del Estudiante</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div><strong>Nombre:</strong> ${PE.Utils.escapeHtml(student.name)}</div>
                            <div><strong>Email:</strong> ${PE.Utils.escapeHtml(student.email)}</div>
                            <div><strong>Nivel:</strong> ${student.level || 'C2'}</div>
                            <div><strong>Progreso:</strong> ${student.progressPercent}%</div>
                        </div>
                    </div>

                    <!-- Resumen de notas -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin: 0 0 1rem;">üìä Resumen Acad√©mico</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                            <div style="text-align: center; padding: 1.5rem; background: var(--bg-light); border-radius: 8px;">
                                <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color);">${student.submissions}</div>
                                <p class="text-secondary mb-0">Entregas</p>
                            </div>
                            <div style="text-align: center; padding: 1.5rem; background: var(--bg-light); border-radius: 8px;">
                                <div style="font-size: 2.5rem; font-weight: 700; color: var(--success-color);">${student.gradedSubmissions}</div>
                                <p class="text-secondary mb-0">Calificadas</p>
                            </div>
                            <div style="text-align: center; padding: 1.5rem; background: var(--bg-light); border-radius: 8px;">
                                <div style="font-size: 2.5rem; font-weight: 700;">${student.totalWords.toLocaleString('es-ES')}</div>
                                <p class="text-secondary mb-0">Palabras</p>
                            </div>
                            <div class="${gradeClass}" style="text-align: center; padding: 1.5rem; border-radius: 8px;">
                                <div style="font-size: 3rem; font-weight: 700;">${gradeText}</div>
                                <p class="mb-0">Nota Media</p>
                            </div>
                        </div>
                    </div>

                    <!-- Detalle de entregas -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin: 0 0 1rem;">üìù Detalle de Entregas</h3>
                        ${student.userSubmissions.length === 0 ?
                            '<p class="text-secondary">No hay entregas registradas.</p>' :
                            `<table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--primary-color); color: white;">
                                        <th style="padding: 0.75rem; text-align: left;">Actividad</th>
                                        <th style="padding: 0.75rem; text-align: left;">Fecha</th>
                                        <th style="padding: 0.75rem; text-align: center;">Palabras</th>
                                        <th style="padding: 0.75rem; text-align: center;">Nota</th>
                                        <th style="padding: 0.75rem; text-align: left;">Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${student.userSubmissions.map(s => {
                                        const gradeNum = parseFloat(s.numeric_grade);
                                        const grade = !isNaN(gradeNum) ? gradeNum.toFixed(1) : '-';
                                        const gradeColor = getGradeClass(gradeNum);
                                        return `
                                            <tr style="border-bottom: 1px solid var(--border-color);">
                                                <td style="padding: 0.75rem;">${PE.Utils.escapeHtml(s.activityTitle || 'Actividad')}</td>
                                                <td style="padding: 0.75rem;">${s.created_at ? PE.Utils.formatDate(s.created_at) : PE.Utils.formatDate(s.createdAt)}</td>
                                                <td style="padding: 0.75rem; text-align: center;">${s.wordCount || s.word_count || 0}</td>
                                                <td style="padding: 0.75rem; text-align: center;">
                                                    ${!isNaN(gradeNum) ? `<span style="padding: 0.25rem 0.5rem; border-radius: 4px;" class="${gradeColor}">${grade}</span>` : '-'}
                                                </td>
                                                <td style="padding: 0.75rem;">
                                                    <span class="badge badge-${s.status === 'reviewed' ? 'success' : 'warning'}">
                                                        ${s.status === 'reviewed' ? 'Corregido' : 'Pendiente'}
                                                    </span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>`
                        }
                    </div>

                    <!-- Comentario del profesor -->
                    ${student.avgGrade !== null ? `
                        <div style="background: var(--bg-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3 style="margin: 0 0 1rem;">üí¨ Evaluaci√≥n General</h3>
                            ${generateEvaluationComment(student)}
                        </div>
                    ` : ''}

                    <!-- Pie del reporte -->
                    <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--border-color);">
                        <p class="text-secondary mb-0">Este bolet√≠n es un documento oficial del curso de Producci√≥n Escrita C2</p>
                        <p class="text-secondary mb-0">CLM - Universidad de Granada</p>
                        <p class="text-secondary mb-0">¬© 2026</p>
                    </div>
                </div>
            `;

            console.log('Calling PE.UI.showModal...');
            if (typeof PE.UI.showModal === 'function') {
                PE.UI.showModal('üìã Bolet√≠n de Notas', reportHtml, [
                    { text: 'Cerrar' },
                    {
                        text: 'üñ®Ô∏è Imprimir',
                        class: 'btn-primary',
                        callback: () => window.print(),
                        close: false
                    },
                    {
                        text: 'üíæ Exportar PDF',
                        class: 'btn-outline',
                        callback: () => exportToPDF(studentId),
                        close: false
                    }
                ]);
                console.log('Modal displayed successfully');
            } else {
                console.error('PE.UI.showModal is not a function');
                PE.UI.notify('Error al mostrar el bolet√≠n', 'error');
            }
        }

        function generateEvaluationComment(student) {
            const avg = student.avgGrade;
            let comment = '';
            
            if (avg >= 9) {
                comment = `El estudiante muestra un desempe√±o excelente en el curso de Producci√≥n Escrita C2. 
                Con una nota media de ${avg.toFixed(1)}, demuestra dominio avanzado de la lengua escrita,
                vocabulario sofisticado y estructuras complejas. Su progreso del ${student.progressPercent}% 
                refleja un compromiso constante con el aprendizaje.`;
            } else if (avg >= 7) {
                comment = `El estudiante presenta un desempe√±o muy bueno en el curso. 
                Con una nota media de ${avg.toFixed(1)}, muestra buen dominio de la escritura acad√©mica
                y capacidad para producir textos de calidad. Su progreso del ${student.progressPercent}% 
                indica un ritmo de aprendizaje s√≥lido.`;
            } else if (avg >= 6) {
                comment = `El estudiante demuestra un buen desempe√±o general. 
                Con una nota media de ${avg.toFixed(1)}, posee las competencias b√°sicas de escritura
                en nivel C2, aunque‰ªçÊúâ espacios para mejorar en la precisi√≥n y sofisticaci√≥n ling√º√≠stica.
                Su progreso del ${student.progressPercent}% es satisfactorio.`;
            } else if (avg >= 5) {
                comment = `El estudiante alcanza el nivel suficiente en el curso. 
                Con una nota media de ${avg.toFixed(1)}, cumple con los requisitos m√≠nimos de
                Producci√≥n Escrita C2. Se recomienda reforzar la pr√°ctica escrita para mejorar
                la fluidez y precisi√≥n. Progreso actual: ${student.progressPercent}%.`;
            } else {
                comment = `El estudiante presenta dificultades para alcanzar los objetivos del nivel C2.
                Con una nota media de ${avg.toFixed(1)}, requiere apoyo adicional y pr√°ctica intensiva
                de escritura acad√©mica. Progreso actual: ${student.progressPercent}%. Se sugiere tutor√≠a
                personalizada.`;
            }
            
            return comment;
        }

        function printReport(studentId) {
            viewReport(studentId);
            // Esperar a que el modal se renderice antes de imprimir
            setTimeout(() => {
                window.print();
            }, 1000);
        }

        function exportToPDF(studentId) {
            const student = allStudents.find(s => String(s.id) === String(studentId));
            if (!student) return;

            const gradeClass = getGradeClass(student.avgGrade);
            const gradeText = student.avgGrade ? student.avgGrade.toFixed(1) : '-';
            const today = new Date().toLocaleDateString('es-ES', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });

            // Crear contenido HTML para PDF
            const pdfContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Bolet√≠n - ${student.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 2rem; color: #333; }
                        h1, h2, h3 { color: #c53030; }
                        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
                        th { background: #c53030; color: white; padding: 0.75rem; text-align: left; }
                        td { padding: 0.75rem; border-bottom: 1px solid #ddd; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
                        .badge-success { background: #28a745; color: white; }
                        .badge-warning { background: #ffc107; color: #000; }
                        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin: 2rem 0; }
                        .summary-item { text-align: center; padding: 1.5rem; background: #f5f5f5; border-radius: 8px; }
                        .summary-value { font-size: 2rem; font-weight: 700; }
                        @media print { body { padding: 1cm; } }
                    </style>
                </head>
                <body>
                    <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #c53030; padding-bottom: 1rem;">
                        <h1 style="margin: 0;">BOLET√çN DE CALIFICACIONES</h1>
                        <p style="margin: 0.5rem 0;">Producci√≥n Escrita C2 - CLM UGR</p>
                        <p style="margin: 0;"><strong>Fecha:</strong> ${today}</p>
                    </div>

                    <div style="background: #f5f5f5; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3>Datos del Estudiante</h3>
                        <p><strong>Nombre:</strong> ${student.name}</p>
                        <p><strong>Email:</strong> ${student.email}</p>
                        <p><strong>Nivel:</strong> ${student.level || 'C2'}</p>
                        <p><strong>Progreso:</strong> ${student.progressPercent}%</p>
                    </div>

                    <h3>Resumen Acad√©mico</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-value" style="color: #c53030;">${student.submissions}</div>
                            <p>Entregas</p>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" style="color: #28a745;">${student.gradedSubmissions}</div>
                            <p>Calificadas</p>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${student.totalWords.toLocaleString('es-ES')}</div>
                            <p>Palabras</p>
                        </div>
                        <div class="summary-item" style="background: ${student.avgGrade !== null ? getGradeColor(student.avgGrade) : '#f5f5f5'};">
                            <div class="summary-value" style="color: ${student.avgGrade !== null ? 'white' : '#333'};">${gradeText}</div>
                            <p style="color: ${student.avgGrade !== null ? 'rgba(255,255,255,0.9)' : '#666'};">Nota Media</p>
                        </div>
                    </div>

                    <h3>Detalle de Entregas</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Actividad</th>
                                <th>Fecha</th>
                                <th>Palabras</th>
                                <th>Nota</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${student.userSubmissions.map(s => {
                                const gradeNum = parseFloat(s.numeric_grade);
                                const grade = !isNaN(gradeNum) ? gradeNum.toFixed(1) : '-';
                                return `
                                    <tr>
                                        <td>${s.activityTitle || 'Actividad'}</td>
                                        <td>${s.created_at ? PE.Utils.formatDate(s.created_at) : PE.Utils.formatDate(s.createdAt)}</td>
                                        <td>${s.wordCount || s.word_count || 0}</td>
                                        <td>${grade}</td>
                                        <td>
                                            <span class="badge badge-${s.status === 'reviewed' ? 'success' : 'warning'}">
                                                ${s.status === 'reviewed' ? 'Corregido' : 'Pendiente'}
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <div style="text-align: center; margin-top: 3rem; border-top: 2px solid #ddd; padding-top: 1rem;">
                        <p>Este bolet√≠n es un documento oficial del curso de Producci√≥n Escrita C2</p>
                        <p>CLM - Universidad de Granada | ¬© 2026</p>
                    </div>
                </body>
                </html>
            `;

            // Crear blob y descargar
            const blob = new Blob([pdfContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `boletin_${student.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);

            PE.UI.notify(`Bolet√≠n de ${student.name} descargado en Carpeta de Descargas`, 'success');
        }

        function getGradeColor(grade) {
            if (grade >= 9) return '#28a745';
            if (grade >= 7) return '#007bff';
            if (grade >= 6) return '#17a2b8';
            if (grade >= 5) return '#ffc107';
            return '#dc3545';
        }

        function generateAllReports() {
            const studentsWithGrades = allStudents.filter(s => s.avgGrade !== null);

            if (studentsWithGrades.length === 0) {
                PE.UI.notify('No hay estudiantes con calificaciones para generar boletines', 'warning');
                return;
            }

            PE.UI.notify(`Generando ${studentsWithGrades.length} boletines...`, 'info');

            // Descargar boletines individualmente
            studentsWithGrades.forEach((student, index) => {
                setTimeout(() => {
                    exportToPDF(student.id);
                }, index * 500); // 500ms de retraso entre cada descarga
            });

            setTimeout(() => {
                PE.UI.notify(`Boletines generados: ${studentsWithGrades.length}`, 'success');
            }, studentsWithGrades.length * 500 + 500);
        }
    </script>
</body>
</html>