<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correcciones | Panel Admin - Producci√≥n Escrita C2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .admin-header { background: linear-gradient(135deg, #c53030, #9b2c2c); }
        .submission-card { border-left: 4px solid var(--warning-color); }
        .submission-card.reviewed { border-left-color: var(--success-color); }
    </style>
</head>
<body>
    <header class="header admin-header">
        <div class="header-main">
            <div class="container">
                <a href="../index.html" class="logo">
                    <div class="logo-icon">C2</div>
                    <div class="logo-text">
                        <span class="logo-title">Panel de Administraci√≥n</span>
                        <span class="logo-subtitle">CLM - UGR</span>
                    </div>
                </a>
                <nav class="nav-main"><a href="../index.html">Ver curso</a><a href="../sesiones/index.html">Sesiones</a></nav>
                <div class="nav-auth"></div>
            </div>
        </div>
    </header>

    <main class="section">
        <div class="container">
            <div class="page-with-sidebar">
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <h4 class="sidebar-title">Administraci√≥n</h4>
                        <ul class="sidebar-nav">
                            <li><a href="index.html">Panel principal</a></li>
                            <li><a href="estudiantes.html">Estudiantes</a></li>
                            <li><a href="correcciones.html" class="active">Correcciones</a></li>
                        </ul>
                    </div>
                    <div class="sidebar-section">
                        <button onclick="PE.Auth.logout()" class="btn btn-outline btn-block">Cerrar sesi√≥n</button>
                    </div>
                </aside>

                <div class="main-content">
                    <h1>Correcci√≥n de entregas</h1>
                    <p class="text-secondary mb-4">Revisa y proporciona retroalimentaci√≥n a las entregas de los estudiantes</p>

                    <!-- Estad√≠sticas -->
                    <div class="sessions-grid mb-4" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" id="stat-total">0</h3>
                                <p class="text-secondary mb-0">Total entregas</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 style="color: var(--warning-color);" id="stat-pending">0</h3>
                                <p class="text-secondary mb-0">Pendientes</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 style="color: var(--success-color);" id="stat-reviewed">0</h3>
                                <p class="text-secondary mb-0">Corregidas</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros avanzados -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <!-- Filtros principales -->
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                <button class="btn btn-sm btn-primary filter-btn active" data-filter="pending">
                                    üìù Pendientes <span class="badge badge-light ml-1" id="count-pending">0</span>
                                </button>
                                <button class="btn btn-sm btn-outline filter-btn" data-filter="recent">
                                    üïí Recientes (7 d√≠as) <span class="badge badge-light ml-1" id="count-recent">0</span>
                                </button>
                                <button class="btn btn-sm btn-outline filter-btn" data-filter="reviewed">
                                    ‚úì Corregidas (archivo) <span class="badge badge-light ml-1" id="count-reviewed">0</span>
                                </button>
                                <button class="btn btn-sm btn-outline filter-btn" data-filter="all">
                                    üìã Todas
                                </button>
                            </div>

                            <!-- Filtros adicionales -->
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                <input type="text" id="search-input" class="form-control" placeholder="üîç Buscar por estudiante o actividad..." style="flex: 1; min-width: 250px; max-width: 400px;">

                                <select id="session-filter" class="form-control form-select" style="width: auto;">
                                    <option value="">Todas las sesiones</option>
                                </select>

                                <select id="student-filter" class="form-control form-select" style="width: auto;">
                                    <option value="">Todos los estudiantes</option>
                                </select>

                                <select id="limit-select" class="form-control form-select" style="width: auto;">
                                    <option value="20">20 por p√°gina</option>
                                    <option value="50">50 por p√°gina</option>
                                    <option value="100">100 por p√°gina</option>
                                </select>

                                <button class="btn btn-sm btn-outline" onclick="resetFilters()">üîÑ Limpiar filtros</button>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n de paginaci√≥n -->
                    <div class="card mb-3" id="pagination-info" style="display: none;">
                        <div class="card-body" style="padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <span class="text-secondary" id="pagination-text">Mostrando 1-20 de 100</span>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm btn-outline" id="prev-page" disabled>‚Üê Anterior</button>
                                <span class="text-secondary" style="padding: 0.25rem 0.5rem;" id="page-indicator">P√°gina 1</span>
                                <button class="btn btn-sm btn-outline" id="next-page">Siguiente ‚Üí</button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de entregas -->
                    <div id="submissions-list"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom" style="border:none;padding-top:0;">
                <span>&copy; 2026 Javier Ben√≠tez L√°inez | CLM - UGR</span>
            </div>
        </div>
    </footer>

    <script>
        window.PE_CONFIG = {
            API_URL: 'https://produccion-escrita-c2-api-production.up.railway.app'
        };
    </script>
    <script src="../js/app.js"></script>
    <script>
        // Estado global de la aplicaci√≥n
        let allSubmissions = [];
        let allUsers = [];
        let currentPage = 1;
        let itemsPerPage = 20;
        let currentFilter = 'pending';
        let filteredSubmissions = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const user = PE.Auth.getCurrentUser();
            if (!user || user.role !== 'admin') {
                window.location.href = '../auth/login.html';
                return;
            }

            // Cargar datos
            await loadData();

            // Configurar event listeners
            setupEventListeners();

            // Render inicial
            applyFilters();
        });

        async function loadData() {
            try {
                allSubmissions = await PE.Submissions.getAll();
                allSubmissions = Array.isArray(allSubmissions) ? allSubmissions : [];

                allUsers = await PE.API.get('/users');
                allUsers = Array.isArray(allUsers) ? allUsers.filter(u => (u.role || 'student') !== 'admin') : [];

                // Actualizar contadores
                const pending = allSubmissions.filter(s => s.status === 'pending');
                const recent = allSubmissions.filter(s => {
                    const daysDiff = (Date.now() - new Date(s.createdAt).getTime()) / (1000 * 60 * 60 * 24);
                    return daysDiff <= 7;
                });
                const reviewed = allSubmissions.filter(s => s.status === 'reviewed');

                document.getElementById('stat-total').textContent = allSubmissions.length;
                document.getElementById('stat-pending').textContent = pending.length;
                document.getElementById('stat-reviewed').textContent = reviewed.length;
                document.getElementById('count-pending').textContent = pending.length;
                document.getElementById('count-recent').textContent = recent.length;
                document.getElementById('count-reviewed').textContent = reviewed.length;

                // Poblar selects
                populateFilters();

            } catch (error) {
                console.error('Error cargando datos:', error);
                PE.UI.notify('Error al cargar los datos', 'error');
            }
        }

        function populateFilters() {
            // Poblar filtro de sesiones
            const sessionFilter = document.getElementById('session-filter');
            const sessions = PE.CourseData.sessions;
            sessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.id;
                option.textContent = `Sesi√≥n ${session.id}: ${session.title}`;
                sessionFilter.appendChild(option);
            });

            // Poblar filtro de estudiantes
            const studentFilter = document.getElementById('student-filter');
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                studentFilter.appendChild(option);
            });
        }

        function setupEventListeners() {
            // Filtros principales
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('active', 'btn-primary');
                        b.classList.add('btn-outline');
                    });
                    btn.classList.add('active', 'btn-primary');
                    btn.classList.remove('btn-outline');
                    currentFilter = btn.dataset.filter;
                    currentPage = 1;
                    applyFilters();
                });
            });

            // B√∫squeda
            document.getElementById('search-input').addEventListener('input', PE.Utils.debounce(() => {
                currentPage = 1;
                applyFilters();
            }, 300));

            // Filtro de sesi√≥n
            document.getElementById('session-filter').addEventListener('change', () => {
                currentPage = 1;
                applyFilters();
            });

            // Filtro de estudiante
            document.getElementById('student-filter').addEventListener('change', () => {
                currentPage = 1;
                applyFilters();
            });

            // L√≠mite por p√°gina
            document.getElementById('limit-select').addEventListener('change', (e) => {
                itemsPerPage = parseInt(e.target.value);
                currentPage = 1;
                applyFilters();
            });

            // Paginaci√≥n
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage();
                }
            });

            document.getElementById('next-page').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPage();
                }
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const sessionFilter = document.getElementById('session-filter').value;
            const studentFilter = document.getElementById('student-filter').value;

            filteredSubmissions = allSubmissions.filter(s => {
                // Filtro principal
                if (currentFilter === 'pending' && s.status !== 'pending') return false;
                if (currentFilter === 'reviewed' && s.status !== 'reviewed') return false;
                if (currentFilter === 'recent') {
                    const daysDiff = (Date.now() - new Date(s.createdAt).getTime()) / (1000 * 60 * 60 * 24);
                    if (daysDiff > 7) return false;
                }

                // B√∫squeda
                if (searchTerm) {
                    const activityMatch = (s.activityTitle || '').toLowerCase().includes(searchTerm);
                    const studentMatch = (s.userName || '').toLowerCase().includes(searchTerm);
                    if (!activityMatch && !studentMatch) return false;
                }

                // Filtro de sesi√≥n
                if (sessionFilter && String(s.sessionId) !== sessionFilter) return false;

                // Filtro de estudiante
                if (studentFilter && String(s.userId) !== studentFilter) return false;

                return true;
            });

            renderPage();
        }

        function renderPage() {
            const container = document.getElementById('submissions-list');
            const paginationInfo = document.getElementById('pagination-info');

            if (filteredSubmissions.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body text-center">
                            <p class="text-secondary">No hay entregas con estos filtros.</p>
                            <button class="btn btn-outline mt-3" onclick="resetFilters()">Limpiar filtros</button>
                        </div>
                    </div>
                `;
                paginationInfo.style.display = 'none';
                return;
            }

            // Calcular paginaci√≥n
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedSubmissions = filteredSubmissions.slice(startIndex, endIndex);
            const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);

            // Mostrar info de paginaci√≥n
            paginationInfo.style.display = 'block';
            document.getElementById('pagination-text').textContent =
                `Mostrando ${startIndex + 1}-${Math.min(endIndex, filteredSubmissions.length)} de ${filteredSubmissions.length}`;
            document.getElementById('page-indicator').textContent = `P√°gina ${currentPage} de ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;

            // Renderizar entregas
            container.innerHTML = paginatedSubmissions.map(s => `
                <div class="card mb-3 submission-card ${s.status === 'reviewed' ? 'reviewed' : ''}">
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                            <div style="flex: 1; min-width: 300px;">
                                <h4 style="margin: 0 0 0.5rem;">${PE.Utils.escapeHtml(s.activityTitle)}</h4>
                                <p class="text-secondary mb-1">
                                    <strong>Estudiante:</strong> ${PE.Utils.escapeHtml(s.userName || 'Estudiante')}
                                </p>
                                <p class="text-secondary mb-2">
                                    üìÖ Entregado: ${PE.Utils.formatDate(s.createdAt, 'long')} |
                                    üìù ${s.wordCount} palabras
                                    ${s.sessionId ? ` | üéì Sesi√≥n ${s.sessionId}` : ''}
                                </p>
                                <span class="badge badge-${s.status === 'reviewed' ? 'success' : 'warning'}">
                                    ${s.status === 'reviewed' ? '‚úì Corregido' : 'üìù Pendiente'}
                                </span>
                            </div>
                            <button class="btn ${s.status === 'reviewed' ? 'btn-outline' : 'btn-primary'}" onclick="reviewSubmission('${s.id}')">
                                ${s.status === 'reviewed' ? 'üëÅÔ∏è Ver/Editar' : '‚úçÔ∏è Corregir'}
                            </button>
                        </div>
                        <div style="background: var(--bg-light); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; max-height: 150px; overflow-y: auto;">
                            ${s.content.substring(0, 500)}${s.content.length > 500 ? '...' : ''}
                        </div>
                        ${s.feedback ? `
                            <div class="alert alert-success mt-3">
                                <strong>üí¨ Tu correcci√≥n:</strong> ${PE.Utils.escapeHtml(s.feedback)}
                                ${s.grade ? ` | <strong>‚≠ê Calificaci√≥n:</strong> ${s.grade}` : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('session-filter').value = '';
            document.getElementById('student-filter').value = '';
            document.getElementById('limit-select').value = '20';
            itemsPerPage = 20;
            currentPage = 1;
            currentFilter = 'pending';

            // Resetear botones de filtro
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('active', 'btn-primary');
                b.classList.add('btn-outline');
            });
            document.querySelector('[data-filter="pending"]').classList.add('active', 'btn-primary');
            document.querySelector('[data-filter="pending"]').classList.remove('btn-outline');

            applyFilters();
        }

        async function reviewSubmission(id) {
            const targetId = String(id);
            const s = allSubmissions.find(sub => String(sub.id) === targetId);

            if (s) {
                PE.UI.showModal('‚úçÔ∏è Corregir: ' + s.activityTitle, `
                    <p><strong>üë§ Estudiante:</strong> ${PE.Utils.escapeHtml(s.userName || 'Estudiante')}</p>
                    <p><strong>üìÖ Fecha:</strong> ${PE.Utils.formatDate(s.createdAt, 'long')}</p>
                    <div style="background: var(--bg-light); padding: 1rem; border-radius: 0.5rem; max-height: 300px; overflow-y: auto; margin-bottom: 1rem; border: 1px solid var(--border-color);">
                        ${s.content}
                            </div>
                    <p class="text-secondary mb-2">üìù ${s.wordCount} palabras</p>
                    <div class="form-group">
                        <label class="form-label">üí¨ Retroalimentaci√≥n</label>
                        <textarea id="feedback-text" class="form-control" rows="6" placeholder="Escribe tu correcci√≥n y comentarios...">${s.feedback || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‚≠ê Calificaci√≥n</label>
                        <select id="feedback-grade" class="form-control form-select">
                            <option value="">Sin calificaci√≥n</option>
                            <option value="Excelente" ${s.grade === 'Excelente' ? 'selected' : ''}>Excelente</option>
                            <option value="Muy bien" ${s.grade === 'Muy bien' ? 'selected' : ''}>Muy bien</option>
                            <option value="Bien" ${s.grade === 'Bien' ? 'selected' : ''}>Bien</option>
                            <option value="Suficiente" ${s.grade === 'Suficiente' ? 'selected' : ''}>Suficiente</option>
                            <option value="Necesita mejorar" ${s.grade === 'Necesita mejorar' ? 'selected' : ''}>Necesita mejorar</option>
                        </select>
                    </div>
                `, [
                    { text: 'Cancelar' },
                    {
                        text: 'üíæ Guardar correcci√≥n',
                        class: 'btn-primary',
                        callback: async () => {
                            const feedback = document.getElementById('feedback-text').value;
                            const grade = document.getElementById('feedback-grade').value;
                            if (!feedback.trim()) {
                                PE.UI.notify('Escribe tu retroalimentaci√≥n', 'error');
                                return;
                            }
                            await PE.Submissions.addFeedback(id, feedback, grade);
                            PE.UI.notify('‚úÖ Correcci√≥n guardada correctamente', 'success');
                            location.reload();
                        },
                        close: false
                    }
                ]);
            }
        }
    </script>
</body>
</html>
