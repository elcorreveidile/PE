<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuarios | Panel de Administracion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .admin-header { background: linear-gradient(135deg, #c53030, #9b2c2c); }
        .admin-badge { background: #c53030; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem; }
        .student-card { padding: var(--spacing-md); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); margin-bottom: var(--spacing-sm); transition: all var(--transition-fast); }
        .student-card:hover { background: var(--bg-light); border-color: var(--primary-light); }
        .student-info { display: flex; align-items: center; gap: 1rem; }
        .student-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.25rem; }
        .student-details { flex: 1; }
        .student-stats { display: flex; gap: 1rem; text-align: center; }
        .student-stat { padding: 0.5rem 1rem; background: var(--bg-light); border-radius: var(--border-radius-sm); }
        .student-stat-value { font-weight: 600; color: var(--primary-color); }
        .student-stat-label { font-size: 0.75rem; color: var(--text-secondary); }
    </style>
</head>
<body>
    <header class="header admin-header">
        <div class="header-main">
            <div class="container">
                <a href="../index.html" class="logo">
                    <div class="logo-icon">C2</div>
                    <div class="logo-text">
                        <span class="logo-title">Panel de Administracion <span class="admin-badge">ADMIN</span></span>
                        <span class="logo-subtitle">CLM - UGR</span>
                    </div>
                </a>
                <nav class="nav-main"><a href="../index.html">Ver curso</a><a href="../sesiones/index.html">Sesiones</a></nav>
                <div class="nav-auth"></div>
            </div>
        </div>
    </header>

    <main class="section">
        <div class="container">
            <div class="page-with-sidebar">
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <h4 class="sidebar-title">Administracion</h4>
                        <ul class="sidebar-nav">
                            <li><a href="index.html">Panel principal</a></li>
                            <li><a href="estudiantes.html" class="active">Estudiantes</a></li>
                            <li><a href="correcciones.html">Correcciones</a></li>
                            <li><a href="notificaciones.html">Notificaciones</a></li>
                            <li><a href="asistencia.html">Asistencia QR</a></li>
                            <li><a href="tareas.html">Gestion de tareas</a></li>
                            <li><a href="estadisticas.html">Estadisticas</a></li>
                            <li><a href="comparacion.html">Comparacion</a></li>
                            <li><a href="rubricas.html">游늵 R칰bricas</a></li>
                            <li><a href="boletines.html">游늶 Boletines</a></li>
                        </ul>
                    </div>
                    <div class="sidebar-section">
                        <button onclick="PE.Auth.logout()" class="btn btn-outline btn-block">Cerrar sesion</button>
                    </div>
                </aside>

                <div class="main-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl);">
                        <div>
                            <h1 style="margin-bottom: 0.25rem;">Gestion de usuarios</h1>
                            <p class="text-secondary mb-0">Crea, edita y gestiona estudiantes y profesores del curso</p>
                        </div>
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <button class="btn btn-primary" id="create-user-btn">Crear usuario</button>
                            <button class="btn btn-outline" onclick="exportData('csv')" title="Exportar a CSV">游늵 CSV</button>
                            <button class="btn btn-outline" onclick="exportData('xlsx')" title="Exportar a Excel">游늳 Excel</button>
                            <span class="badge badge-primary" id="total-users">0 usuarios</span>
                        </div>
                    </div>

                    <!-- Filtros y busqueda -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                                <input type="text" id="search-input" class="form-control" placeholder="Buscar por nombre o email..." style="flex: 1; min-width: 200px;">
                                <select id="filter-role" class="form-control form-select" style="width: auto;">
                                    <option value="">Todos los roles</option>
                                    <option value="student">Estudiantes</option>
                                    <option value="admin">Profesores</option>
                                </select>
                                <select id="filter-level" class="form-control form-select" style="width: auto;">
                                    <option value="">Todos los niveles</option>
                                    <option value="C2-8">C2-8</option>
                                    <option value="C2-9">C2-9</option>
                                    <option value="C2">C2</option>
                                </select>
                                <select id="filter-activity" class="form-control form-select" style="width: auto;">
                                    <option value="">Toda actividad</option>
                                    <option value="active">Con entregas</option>
                                    <option value="inactive">Sin entregas</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de estudiantes -->
                    <div id="students-list">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom" style="border:none;padding-top:0;">
                <span>&copy; 2026 Javier Benitez Lainez | CLM - UGR</span>
            </div>
        </div>
    </footer>

    <script>
        window.PE_CONFIG = {
            API_URL: 'https://produccion-escrita-c2-api-production.up.railway.app'
        };
    </script>
    <script src="../js/config.js"></script>
<script src="../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const basePath = window.location.pathname.includes('/PE/') ? '/PE' : '';
            const user = PE.Auth.getCurrentUser();
            if (!user || user.role !== 'admin') {
                window.location.href = basePath + '/auth/login.html';
                return;
            }

            const API = PE.API;
            const CONFIG = window.PE_CONFIG || { USE_API: false, API_URL: '' };
            const Utils = PE.Utils;

            try {
                await API.ensureAvailability();
                CONFIG.USE_API = true;
            } catch (e) {
                console.error('API no disponible:', e);
            }

            let users = [];
            let submissions = [];

            async function loadData() {
                try {
                    if (CONFIG.USE_API) {
                        users = await API.get('/users');
                        submissions = [];
                    } else {
                        users = Utils.storage.get('users') || [];
                        submissions = await PE.Submissions.getAll();
                        submissions = Array.isArray(submissions) ? submissions : [];
                    }
                } catch (e) {
                    console.error('Error cargando datos:', e);
                    users = [];
                }
                // Contar solo estudiantes (excluir admin)
                const studentCount = users.filter(u => (u.role || 'student') !== 'admin').length;
                document.getElementById('total-users').textContent = studentCount + ' estudiantes';
            }

            function getStatsForUser(current) {
                if (CONFIG.USE_API) {
                    const total = current.submissions_count || 0;
                    const reviewed = current.reviewed_count || 0;
                    const pending = Math.max(total - reviewed, 0);
                    return { total, reviewed, pending };
                }

                const userSubmissions = submissions.filter(sub => String(sub.userId) === String(current.id));
                const reviewed = userSubmissions.filter(sub => sub.status === 'reviewed');
                const pending = userSubmissions.filter(sub => sub.status === 'pending');
                return {
                    total: userSubmissions.length,
                    reviewed: reviewed.length,
                    pending: pending.length
                };
            }

            function renderUsers(filter = {}) {
                let filtered = [...users];

                // Por defecto, excluir administradores (profesores) de la lista
                // Solo mostrarlos si el filtro de rol espec칤ficamente lo pide
                if (!filter.role || filter.role !== 'admin') {
                    filtered = filtered.filter(u => (u.role || 'student') !== 'admin');
                }

                if (filter.search) {
                    const search = filter.search.toLowerCase();
                    filtered = filtered.filter(u =>
                        u.name.toLowerCase().includes(search) ||
                        u.email.toLowerCase().includes(search)
                    );
                }

                if (filter.level) {
                    filtered = filtered.filter(u => (u.level || 'C2') === filter.level);
                }

                if (filter.role) {
                    filtered = filtered.filter(u => (u.role || 'student') === filter.role);
                }

                if (filter.activity === 'active') {
                    filtered = filtered.filter(u => getStatsForUser(u).total > 0);
                } else if (filter.activity === 'inactive') {
                    filtered = filtered.filter(u => getStatsForUser(u).total === 0);
                }

                const container = document.getElementById('students-list');

                if (filtered.length === 0) {
                    container.innerHTML = '<div class="card"><div class="card-body text-center"><p class="text-secondary">No se encontraron usuarios.</p></div></div>';
                    return;
                }

                container.innerHTML = filtered.map(u => {
                    const stats = getStatsForUser(u);
                    const initials = u.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    const roleLabel = (u.role || 'student') === 'admin' ? 'Profesor' : 'Estudiante';
                    const roleClass = (u.role || 'student') === 'admin' ? 'badge-warning' : 'badge-primary';
                    const createdAt = u.created_at || u.createdAt;
                    const canDelete = String(u.id) !== String(user.id);

                    return `
                        <div class="student-card">
                            <div class="student-info">
                                <div class="student-avatar">${initials}</div>
                                <div class="student-details">
                                    <h4 style="margin: 0;">${PE.Utils.escapeHtml(u.name)}</h4>
                                    <p class="text-secondary mb-0" style="font-size: 0.875rem;">${PE.Utils.escapeHtml(u.email)}</p>
                                    <div style="margin-top: 0.5rem;">
                                        <span class="badge ${roleClass}">${roleLabel}</span>
                                        ${(u.role || 'student') === 'student' ? `<span class="badge badge-primary">${u.level || 'C2'}</span>` : ''}
                                        <span class="text-secondary" style="font-size: 0.8rem; margin-left: 0.5rem;">
                                            Registro: ${createdAt ? PE.Utils.formatDate(createdAt) : '-'}
                                        </span>
                                    </div>
                                </div>
                                <div class="student-stats">
                                    <div class="student-stat">
                                        <div class="student-stat-value">${stats.total}</div>
                                        <div class="student-stat-label">Entregas</div>
                                    </div>
                                    <div class="student-stat">
                                        <div class="student-stat-value">${stats.reviewed}</div>
                                        <div class="student-stat-label">Corregidas</div>
                                    </div>
                                    <div class="student-stat">
                                        <div class="student-stat-value">${stats.pending}</div>
                                        <div class="student-stat-label">Pendientes</div>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline" onclick="viewUser('${u.id}')">Ver detalle</button>
                                    <button class="btn btn-sm btn-ghost" ${canDelete ? '' : 'disabled'} onclick="deleteUser('${u.id}')">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async function refresh() {
                await loadData();
                renderUsers(getFilters());
            }

            function getFilters() {
                return {
                    search: document.getElementById('search-input').value,
                    level: document.getElementById('filter-level').value,
                    role: document.getElementById('filter-role').value,
                    activity: document.getElementById('filter-activity').value
                };
            }

            // Filtros
            document.getElementById('search-input').addEventListener('input', PE.Utils.debounce((e) => {
                renderUsers(getFilters());
            }, 300));

            document.getElementById('filter-level').addEventListener('change', (e) => {
                renderUsers(getFilters());
            });

            document.getElementById('filter-activity').addEventListener('change', (e) => {
                renderUsers(getFilters());
            });

            document.getElementById('filter-role').addEventListener('change', () => {
                renderUsers(getFilters());
            });

            document.getElementById('create-user-btn').addEventListener('click', () => {
                const modal = PE.UI.showModal('Crear usuario', `
                    <div class="form-group">
                        <label class="form-label required">Nombre completo</label>
                        <input type="text" id="new-name" class="form-control" placeholder="Nombre y apellidos">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Correo electr칩nico</label>
                        <input type="email" id="new-email" class="form-control" placeholder="email@dominio.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Contrase침a</label>
                        <input type="password" id="new-password" class="form-control" placeholder="M칤nimo 6 caracteres">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Rol</label>
                            <select id="new-role" class="form-control form-select">
                                <option value="student">Estudiante</option>
                                <option value="admin">Profesor</option>
                            </select>
                        </div>
                        <div class="form-group" id="level-group">
                            <label class="form-label">Nivel</label>
                            <select id="new-level" class="form-control form-select">
                                <option value="C2-8">C2-8</option>
                                <option value="C2-9">C2-9</option>
                                <option value="C2" selected>C2</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <select id="new-active" class="form-control form-select">
                            <option value="true" selected>Activo</option>
                            <option value="false">Desactivado</option>
                        </select>
                    </div>
                    <div class="form-errors"></div>
                `, [
                    { text: 'Cancelar' },
                    {
                        text: 'Crear',
                        class: 'btn-primary',
                        close: false,
                        callback: async () => {
                            const name = document.getElementById('new-name').value.trim();
                            const email = document.getElementById('new-email').value.trim();
                            const password = document.getElementById('new-password').value;
                            const role = document.getElementById('new-role').value;
                            const level = document.getElementById('new-level').value;
                            const active = document.getElementById('new-active').value === 'true';
                            const errors = [];

                            if (!name || name.length < 2) errors.push('Nombre inv치lido');
                            if (!email || !PE.Utils.isValidEmail(email)) errors.push('Email inv치lido');
                            if (!password || password.length < 6) errors.push('Contrase침a demasiado corta');

                            const errorsContainer = modal.querySelector('.form-errors');
                            if (errors.length > 0) {
                                errorsContainer.innerHTML = errors.map(err => `<div class="alert alert-error">${err}</div>`).join('');
                                return;
                            }

                            try {
                                if (CONFIG.USE_API) {
                                    await API.post('/users', { name, email, password, role, level, active });
                                } else {
                                    const stored = Utils.storage.get('users') || [];
                                    if (stored.find(u => u.email === email)) {
                                        throw new Error('Este email ya est치 registrado');
                                    }
                                    stored.push({
                                        id: PE.Utils.generateId(),
                                        email,
                                        password,
                                        name,
                                        role,
                                        level,
                                        active,
                                        createdAt: new Date().toISOString()
                                    });
                                    Utils.storage.set('users', stored);
                                }
                                modal.remove();
                                await refresh();
                                PE.UI.notify('Usuario creado correctamente', 'success');
                            } catch (error) {
                                errorsContainer.innerHTML = `<div class="alert alert-error">${error.message || 'Error al crear usuario'}</div>`;
                            }
                        }
                    }
                ]);

                const roleSelect = modal.querySelector('#new-role');
                const levelGroup = modal.querySelector('#level-group');
                roleSelect.addEventListener('change', () => {
                    levelGroup.style.display = roleSelect.value === 'student' ? '' : 'none';
                });
            });

            await refresh();

            window.viewUser = async (id) => {
                if (CONFIG.USE_API) {
                    const userDetail = await API.get(`/users/${id}`);
                    const submissionsList = (userDetail.submissions || []).length === 0
                        ? '<p class="text-secondary">No hay entregas registradas.</p>'
                        : userDetail.submissions.map(s => `
                            <div style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>${PE.Utils.escapeHtml(s.activity_title || s.activityTitle)}</strong>
                                    <span class="badge badge-${s.status === 'reviewed' ? 'success' : 'warning'}">
                                        ${s.status === 'reviewed' ? 'Corregido' : 'Pendiente'}
                                    </span>
                                </div>
                                <p class="text-secondary mb-0" style="font-size: 0.8rem;">
                                    ${PE.Utils.formatDate(s.created_at || s.createdAt)} - ${s.word_count || s.wordCount || 0} palabras
                                </p>
                            </div>
                        `).join('');

                    PE.UI.showModal('Detalle del usuario', `
                        <div class="mb-3"><strong>Nombre:</strong> ${PE.Utils.escapeHtml(userDetail.name)}</div>
                        <div class="mb-3"><strong>Email:</strong> ${PE.Utils.escapeHtml(userDetail.email)}</div>
                        <div class="mb-3"><strong>Rol:</strong> ${(userDetail.role === 'admin') ? 'Profesor' : 'Estudiante'}</div>
                        ${userDetail.role === 'student' ? `<div class="mb-3"><strong>Nivel:</strong> ${userDetail.level || 'C2'}</div>` : ''}
                        <div class="mb-3"><strong>Fecha de registro:</strong> ${PE.Utils.formatDate(userDetail.created_at || userDetail.createdAt, 'long')}</div>
                        <hr>
                        <h4>Entregas (${(userDetail.submissions || []).length})</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${submissionsList}
                        </div>
                    `, [{ text: 'Cerrar' }]);
                    return;
                }

                const storedUsers = Utils.storage.get('users') || [];
                const selected = storedUsers.find(u => String(u.id) === String(id));
                let localSubmissions = await PE.Submissions.getAll();
                localSubmissions = Array.isArray(localSubmissions) ? localSubmissions : [];
                localSubmissions = localSubmissions.filter(s => String(s.userId) === String(id));

                if (selected) {
                    const submissionsList = localSubmissions.length === 0
                        ? '<p class="text-secondary">No hay entregas registradas.</p>'
                        : localSubmissions.map(s => `
                            <div style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>${PE.Utils.escapeHtml(s.activityTitle)}</strong>
                                    <span class="badge badge-${s.status === 'reviewed' ? 'success' : 'warning'}">
                                        ${s.status === 'reviewed' ? 'Corregido' : 'Pendiente'}
                                    </span>
                                </div>
                                <p class="text-secondary mb-0" style="font-size: 0.8rem;">
                                    ${PE.Utils.formatDate(s.createdAt)} - ${s.wordCount} palabras
                                </p>
                            </div>
                        `).join('');

                    PE.UI.showModal('Detalle del usuario', `
                        <div class="mb-3"><strong>Nombre:</strong> ${PE.Utils.escapeHtml(selected.name)}</div>
                        <div class="mb-3"><strong>Email:</strong> ${PE.Utils.escapeHtml(selected.email)}</div>
                        <div class="mb-3"><strong>Rol:</strong> ${(selected.role === 'admin') ? 'Profesor' : 'Estudiante'}</div>
                        ${selected.role === 'student' ? `<div class="mb-3"><strong>Nivel:</strong> ${selected.level || 'C2'}</div>` : ''}
                        <div class="mb-3"><strong>Fecha de registro:</strong> ${PE.Utils.formatDate(selected.createdAt, 'long')}</div>
                        <hr>
                        <h4>Entregas (${localSubmissions.length})</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${submissionsList}
                        </div>
                    `, [{ text: 'Cerrar' }]);
                }
            };

            window.deleteUser = async (id) => {
                if (String(id) === String(user.id)) {
                    PE.UI.notify('No puedes eliminar tu propia cuenta', 'warning');
                    return;
                }

                PE.UI.confirm('쯉eguro que deseas eliminar este usuario?', async () => {
                    try {
                        if (CONFIG.USE_API) {
                            await API.delete(`/users/${id}`);
                        } else {
                            const stored = Utils.storage.get('users') || [];
                            Utils.storage.set('users', stored.filter(u => u.id !== id));
                            const localSubmissions = Utils.storage.get('submissions') || [];
                            Utils.storage.set('submissions', localSubmissions.filter(s => s.userId !== id));
                        }
                        await refresh();
                        PE.UI.notify('Usuario eliminado correctamente', 'success');
                    } catch (error) {
                        PE.UI.notify(error.message || 'Error al eliminar usuario', 'error');
                    }
                });
            };

            // Funci칩n de exportaci칩n (global para que pueda ser llamada desde el HTML)
            window.exportData = async (format) => {
                try {
                    console.log('[EXPORT] Iniciando exportaci칩n con formato:', format);

                    const token = Utils.storage.get('token');
                    console.log('[EXPORT] Token obtenido:', token ? 'S칈' : 'NO');

                    if (!token) {
                        throw new Error('No hay sesi칩n activa');
                    }

                    const url = `${CONFIG.API_URL}/api/users/export/students?format=${format}`;
                    console.log('[EXPORT] URL de petici칩n:', url);

                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    console.log('[EXPORT] Respuesta status:', response.status);
                    console.log('[EXPORT] Respuesta ok:', response.ok);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('[EXPORT] Error response:', errorText);
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch {
                            errorData = { error: errorText };
                        }
                        throw new Error(errorData.error || `Error ${response.status}: ${errorText}`);
                    }

                    // Descargar archivo
                    const blob = await response.blob();
                    console.log('[EXPORT] Blob type:', blob.type);
                    console.log('[EXPORT] Blob size:', blob.size);

                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `estudiantes_${new Date().toISOString().split('T')[0]}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(downloadUrl);
                    document.body.removeChild(a);

                    console.log('[EXPORT] Archivo descargado correctamente');
                    PE.UI.notify(`Datos exportados a ${format.toUpperCase()} correctamente`, 'success');
                } catch (error) {
                    console.error('[EXPORT] Error completo:', error);
                    console.error('[EXPORT] Error stack:', error.stack);
                    PE.UI.notify(error.message || 'Error al exportar datos', 'error');
                }
            };
        });
    </script>
</body>
</html>
