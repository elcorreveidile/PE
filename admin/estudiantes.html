<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudiantes | Panel de Administracion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .admin-header { background: linear-gradient(135deg, #c53030, #9b2c2c); }
        .admin-badge { background: #c53030; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem; }
        .student-card { padding: var(--spacing-md); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); margin-bottom: var(--spacing-sm); transition: all var(--transition-fast); }
        .student-card:hover { background: var(--bg-light); border-color: var(--primary-light); }
        .student-info { display: flex; align-items: center; gap: 1rem; }
        .student-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.25rem; }
        .student-details { flex: 1; }
        .student-stats { display: flex; gap: 1rem; text-align: center; }
        .student-stat { padding: 0.5rem 1rem; background: var(--bg-light); border-radius: var(--border-radius-sm); }
        .student-stat-value { font-weight: 600; color: var(--primary-color); }
        .student-stat-label { font-size: 0.75rem; color: var(--text-secondary); }
    </style>
</head>
<body>
    <header class="header admin-header">
        <div class="header-main">
            <div class="container">
                <a href="../index.html" class="logo">
                    <div class="logo-icon">C2</div>
                    <div class="logo-text">
                        <span class="logo-title">Panel de Administracion <span class="admin-badge">ADMIN</span></span>
                        <span class="logo-subtitle">CLM - UGR</span>
                    </div>
                </a>
                <nav class="nav-main"><a href="../index.html">Ver curso</a><a href="../sesiones/index.html">Sesiones</a></nav>
                <div class="nav-auth"></div>
            </div>
        </div>
    </header>

    <main class="section">
        <div class="container">
            <div class="page-with-sidebar">
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <h4 class="sidebar-title">Administracion</h4>
                        <ul class="sidebar-nav">
                            <li><a href="index.html">Panel principal</a></li>
                            <li><a href="estudiantes.html" class="active">Estudiantes</a></li>
                            <li><a href="correcciones.html">Correcciones</a></li>
                            <li><a href="tareas.html">Gestion de tareas</a></li>
                            <li><a href="estadisticas.html">Estadisticas</a></li>
                        </ul>
                    </div>
                    <div class="sidebar-section">
                        <button onclick="PE.Auth.logout()" class="btn btn-outline btn-block">Cerrar sesion</button>
                    </div>
                </aside>

                <div class="main-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl);">
                        <div>
                            <h1 style="margin-bottom: 0.25rem;">Gestion de estudiantes</h1>
                            <p class="text-secondary mb-0">Listado y seguimiento de todos los estudiantes del curso</p>
                        </div>
                        <span class="badge badge-primary" id="total-students">0 estudiantes</span>
                    </div>

                    <!-- Filtros y busqueda -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                                <input type="text" id="search-input" class="form-control" placeholder="Buscar por nombre o email..." style="flex: 1; min-width: 200px;">
                                <select id="filter-level" class="form-control form-select" style="width: auto;">
                                    <option value="">Todos los niveles</option>
                                    <option value="B2">B2</option>
                                    <option value="C1">C1</option>
                                    <option value="C2">C2</option>
                                </select>
                                <select id="filter-activity" class="form-control form-select" style="width: auto;">
                                    <option value="">Toda actividad</option>
                                    <option value="active">Con entregas</option>
                                    <option value="inactive">Sin entregas</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de estudiantes -->
                    <div id="students-list">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom" style="border:none;padding-top:0;">
                <span>&copy; 2026 Javier Benitez Lainez | CLM - UGR</span>
            </div>
        </div>
    </footer>

    <script src="../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = PE.Auth.getCurrentUser();
            if (!user || user.role !== 'admin') {
                const basePath = window.location.pathname.includes('/PE/') ? '/PE' : '';
                window.location.href = basePath + '/auth/login.html';
                return;
            }

            const users = JSON.parse(localStorage.getItem('pe_c2_users') || '[]');
            const students = users.filter(u => u.role !== 'admin');
            const submissions = await PE.Submissions.getAll();

            document.getElementById('total-students').textContent = students.length + ' estudiantes';

            function renderStudents(filter = {}) {
                let filtered = [...students];

                if (filter.search) {
                    const search = filter.search.toLowerCase();
                    filtered = filtered.filter(s =>
                        s.name.toLowerCase().includes(search) ||
                        s.email.toLowerCase().includes(search)
                    );
                }

                if (filter.level) {
                    filtered = filtered.filter(s => s.level === filter.level);
                }

                if (filter.activity === 'active') {
                    filtered = filtered.filter(s => submissions.some(sub => sub.userId === s.id));
                } else if (filter.activity === 'inactive') {
                    filtered = filtered.filter(s => !submissions.some(sub => sub.userId === s.id));
                }

                const container = document.getElementById('students-list');

                if (filtered.length === 0) {
                    container.innerHTML = '<div class="card"><div class="card-body text-center"><p class="text-secondary">No se encontraron estudiantes.</p></div></div>';
                    return;
                }

                container.innerHTML = filtered.map(s => {
                    const studentSubmissions = submissions.filter(sub => sub.userId === s.id);
                    const reviewed = studentSubmissions.filter(sub => sub.status === 'reviewed');
                    const pending = studentSubmissions.filter(sub => sub.status === 'pending');
                    const initials = s.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

                    return `
                        <div class="student-card">
                            <div class="student-info">
                                <div class="student-avatar">${initials}</div>
                                <div class="student-details">
                                    <h4 style="margin: 0;">${PE.Utils.escapeHtml(s.name)}</h4>
                                    <p class="text-secondary mb-0" style="font-size: 0.875rem;">${PE.Utils.escapeHtml(s.email)}</p>
                                    <div style="margin-top: 0.5rem;">
                                        <span class="badge badge-primary">${s.level || 'C2'}</span>
                                        <span class="text-secondary" style="font-size: 0.8rem; margin-left: 0.5rem;">
                                            Registro: ${PE.Utils.formatDate(s.createdAt)}
                                        </span>
                                    </div>
                                </div>
                                <div class="student-stats">
                                    <div class="student-stat">
                                        <div class="student-stat-value">${studentSubmissions.length}</div>
                                        <div class="student-stat-label">Entregas</div>
                                    </div>
                                    <div class="student-stat">
                                        <div class="student-stat-value">${reviewed.length}</div>
                                        <div class="student-stat-label">Corregidas</div>
                                    </div>
                                    <div class="student-stat">
                                        <div class="student-stat-value">${pending.length}</div>
                                        <div class="student-stat-label">Pendientes</div>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline" onclick="viewStudent('${s.id}')">Ver detalle</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderStudents();

            // Filtros
            document.getElementById('search-input').addEventListener('input', PE.Utils.debounce((e) => {
                renderStudents({
                    search: e.target.value,
                    level: document.getElementById('filter-level').value,
                    activity: document.getElementById('filter-activity').value
                });
            }, 300));

            document.getElementById('filter-level').addEventListener('change', (e) => {
                renderStudents({
                    search: document.getElementById('search-input').value,
                    level: e.target.value,
                    activity: document.getElementById('filter-activity').value
                });
            });

            document.getElementById('filter-activity').addEventListener('change', (e) => {
                renderStudents({
                    search: document.getElementById('search-input').value,
                    level: document.getElementById('filter-level').value,
                    activity: e.target.value
                });
            });
        });

        async function viewStudent(id) {
            const users = JSON.parse(localStorage.getItem('pe_c2_users') || '[]');
            const student = users.find(u => u.id === id);
            const allSubmissions = await PE.Submissions.getAll();
            const submissions = allSubmissions.filter(s => s.userId === id);

            if (student) {
                const submissionsList = submissions.length === 0
                    ? '<p class="text-secondary">No hay entregas registradas.</p>'
                    : submissions.map(s => `
                        <div style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${PE.Utils.escapeHtml(s.activityTitle)}</strong>
                                <span class="badge badge-${s.status === 'reviewed' ? 'success' : 'warning'}">
                                    ${s.status === 'reviewed' ? 'Corregido' : 'Pendiente'}
                                </span>
                            </div>
                            <p class="text-secondary mb-0" style="font-size: 0.8rem;">
                                ${PE.Utils.formatDate(s.createdAt)} - ${s.wordCount} palabras
                            </p>
                        </div>
                    `).join('');

                PE.UI.showModal('Detalle del estudiante', `
                    <div class="mb-3">
                        <strong>Nombre:</strong> ${PE.Utils.escapeHtml(student.name)}
                    </div>
                    <div class="mb-3">
                        <strong>Email:</strong> ${PE.Utils.escapeHtml(student.email)}
                    </div>
                    <div class="mb-3">
                        <strong>Nivel:</strong> ${student.level || 'C2'}
                    </div>
                    <div class="mb-3">
                        <strong>Fecha de registro:</strong> ${PE.Utils.formatDate(student.createdAt, 'long')}
                    </div>
                    <hr>
                    <h4>Entregas (${submissions.length})</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${submissionsList}
                    </div>
                `, [{ text: 'Cerrar' }]);
            }
        }
    </script>
</body>
</html>
