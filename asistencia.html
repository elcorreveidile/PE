<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Asistencia | Producci√≥n Escrita C2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .attendance-hero {
            background: linear-gradient(135deg, #c53030, #9b2c2c);
            color: white;
            padding: 3rem 0;
            text-align: center;
        }
        .attendance-hero h1 {
            color: white;
            margin-bottom: 0.5rem;
        }
        .code-input {
            font-size: 2rem;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.5rem;
            text-align: center;
            text-transform: uppercase;
            font-weight: bold;
        }
        .checkin-card {
            max-width: 500px;
            margin: 2rem auto;
            text-align: center;
        }
        .success-animation {
            animation: scaleIn 0.5s ease-out;
        }
        @keyframes scaleIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Header simplificado -->
    <header class="header">
        <div class="header-main">
            <div class="container">
                <a href="index.html" class="logo">
                    <div class="logo-icon">C2</div>
                    <div class="logo-text">
                        <span class="logo-title">Producci√≥n Escrita</span>
                        <span class="logo-subtitle">Espa√±ol Avanzado</span>
                    </div>
                </a>
            </div>
        </div>
    </header>

    <!-- Hero section -->
    <div class="attendance-hero">
        <div class="container">
            <h1>üì± Control de Asistencia</h1>
            <p>Escanea el c√≥digo QR o ingresa el c√≥digo de verificaci√≥n</p>
        </div>
    </div>

    <main class="section">
        <div class="container">
            <!-- Check-in card -->
            <div class="card checkin-card" id="checkin-form">
                <div class="card-body">
                    <h2 class="mb-3">Confirmar tu Asistencia</h2>
                    <p class="text-secondary mb-4">Ingresa el c√≥digo de 8 caracteres que el profesor ha mostrado en pantalla</p>

                    <form onsubmit="checkIn(event)">
                        <div class="form-group">
                            <label class="form-label">C√≥digo de Verificaci√≥n</label>
                            <input
                                type="text"
                                id="verification-code"
                                class="form-control code-input"
                                maxlength="8"
                                placeholder="--------"
                                pattern="[A-F0-9]{8}"
                                required
                                autocomplete="off"
                                style="text-transform: uppercase;"
                            >
                            <small class="text-secondary">8 caracteres alfanum√©ricos</small>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg btn-block" id="btn-checkin">
                            ‚úÖ Confirmar Asistencia
                        </button>
                    </form>

                    <div id="session-info" style="display: none; margin-top: 1.5rem; padding: 1rem; background: var(--bg-light); border-radius: 0.5rem;">
                        <h6 style="margin-bottom: 0.5rem;">Sesi√≥n:</h6>
                        <p style="margin: 0;" id="session-details"></p>
                    </div>
                </div>
            </div>

            <!-- Success message (hidden by default) -->
            <div class="card checkin-card" id="success-message" style="display: none;">
                <div class="card-body success-animation">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
                    <h2>¬°Asistencia Confirmada!</h2>
                    <p class="text-secondary mb-4">Tu asistencia ha sido registrada exitosamente</p>
                    <div id="success-details" style="padding: 1rem; background: var(--bg-light); border-radius: 0.5rem; margin-bottom: 1rem;"></div>
                    <a href="usuario/dashboard.html" class="btn btn-outline">Ir a mi √°rea de trabajo</a>
                </div>
            </div>

            <!-- Instructions -->
            <div class="card" style="max-width: 600px; margin: 0 auto;">
                <div class="card-body">
                    <h4 style="margin-bottom: 1rem;">üìã Instrucciones</h4>
                    <ol style="padding-left: 1.25rem; line-height: 1.8;">
                        <El profesor mostrar√° un c√≥digo QR en pantalla</li>
                        <li>Escanea el QR con tu c√°mara del m√≥vil</li>
                        <li>O espera a que el profesor comparta el c√≥digo num√©rico</li>
                        <li>Ingresa las 8 letras/n√∫meros del c√≥digo</li>
                        <li>¬°Listo! Tu asistencia queda registrada</li>
                    </ol>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom" style="border: none; padding-top: 0;">
                <span>Producci√≥n Escrita C2 - Curso 2025-2026</span>
            </div>
        </div>
    </footer>

    <script>
        window.PE_CONFIG = {
            API_URL: 'https://produccion-escrita-c2-api-production.up.railway.app'
        };
    </script>
    <script src="js/app.js"></script>
    <script>
        // Verificar si hay c√≥digo en la URL
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                document.getElementById('verification-code').value = code.toUpperCase();
                checkIn(new Event('submit'));
            }
        });

        async function checkIn(event) {
            event.preventDefault();

            const codeInput = document.getElementById('verification-code');
            const btn = document.getElementById('btn-checkin');
            const code = codeInput.value.toUpperCase().trim();

            // Validar formato
            if (!/^[A-F0-9]{8}$/.test(code)) {
                PE.UI.notify('El c√≥digo debe tener 8 caracteres alfanum√©ricos', 'error');
                return;
            }

            // Verificar autenticaci√≥n
            const user = PE.Auth.getCurrentUser();
            if (!user) {
                // Guardar c√≥digo y redirigir a login
                sessionStorage.setItem('pendingCheckinCode', code);
                window.location.href = 'auth/login.html?redirect=' + encodeURIComponent(window.location.href);
                return;
            }

            btn.disabled = true;
            btn.textContent = '‚è≥ Verificando...';

            try {
                // Primero verificar el c√≥digo
                const token = PE.Utils?.storage?.get('token') || localStorage.getItem('pe_c2_token');

                const sessionResponse = await fetch(`${window.PE_CONFIG.API_URL}/api/attendance/session/${code}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!sessionResponse.ok) {
                    throw new Error('C√≥digo no v√°lido o expirado');
                }

                const sessionData = await sessionResponse.json();

                // Mostrar informaci√≥n de la sesi√≥n
                const sessionInfo = document.getElementById('session-info');
                const sessionDetails = document.getElementById('session-details');
                sessionDetails.innerHTML = `
                    <strong>${sessionData.sessionTitle || 'Sesi√≥n'}</strong><br>
                    <small>${sessionData.sessionDay || ''}, ${PE.Utils.formatDate(sessionData.sessionDate)}</small>
                `;
                sessionInfo.style.display = 'block';

                // Confirmar asistencia
                const checkinResponse = await fetch(`${window.PE_CONFIG.API_URL}/api/attendance/check-in`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ verificationCode: code })
                });

                if (!checkinResponse.ok) {
                    const errorData = await checkinResponse.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Error al registrar asistencia');
                }

                const result = await checkinResponse.json();

                // Mostrar √©xito
                document.getElementById('checkin-form').style.display = 'none';
                document.getElementById('success-message').style.display = 'block';

                document.getElementById('success-details').innerHTML = `
                    <p><strong>Sesi√≥n:</strong> ${sessionData.sessionTitle || 'N/A'}</p>
                    <p><strong>Fecha:</strong> ${PE.Utils.formatDate(result.date)}</p>
                    <p><strong>Hora:</strong> ${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</p>
                `;

                // Limpiar c√≥digo pendiente
                sessionStorage.removeItem('pendingCheckinCode');

            } catch (error) {
                console.error('Error en check-in:', error);
                PE.UI.notify(error.message || 'Error al confirmar asistencia', 'error');

                // Ocultar info de sesi√≥n si hay error
                document.getElementById('session-info').style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.textContent = '‚úÖ Confirmar Asistencia';
            }
        }

        // Auto-format input
        document.getElementById('verification-code').addEventListener('input', function(e) {
            this.value = this.value.toUpperCase().replace(/[^A-F0-9]/g, '');
        });
    </script>
</body>
</html>
