<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Progreso | Producción Escrita C2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <header class="header">
        <div class="header-main">
            <div class="container">
                <a href="../index.html" class="logo">
                    <div class="logo-icon">C2</div>
                    <div class="logo-text">
                        <span class="logo-title">Producción Escrita</span>
                        <span class="logo-subtitle">CLM - UGR</span>
                    </div>
                </a>
                <nav class="nav-main"><a href="../index.html">Inicio</a><a href="../sesiones/index.html">Sesiones</a><a href="../talleres/index.html">Talleres</a></nav>
                <div class="nav-auth"></div>
            </div>
        </div>
    </header>

    <main class="section">
        <div class="container">
            <div class="page-with-sidebar">
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <h4 class="sidebar-title">Mi area</h4>
                        <ul class="sidebar-nav">
                            <li><a href="dashboard.html">Panel principal</a></li>
                            <li><a href="mis-entregas.html">Mis entregas</a></li>
                            <li><a href="progreso.html" class="active">Mi progreso</a></li>
                        </ul>
                    </div>
                    <div class="sidebar-section">
                        <button onclick="PE.Auth.logout()" class="btn btn-outline btn-block">Cerrar sesion</button>
                    </div>
                </aside>

                <div class="main-content">
                    <h1>Mi progreso</h1>
                    <p class="text-secondary mb-4">Seguimiento de tu avance en el curso de Produccion Escrita C2</p>

                    <!-- Resumen general -->
                    <div class="sessions-grid mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" style="font-size: 2.5rem; margin-bottom: 0.5rem;" id="stat-sessions">0</h3>
                                <p class="text-secondary mb-0">Sesiones completadas</p>
                                <p class="text-secondary" style="font-size: 0.85rem;">de 27 totales</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" style="font-size: 2.5rem; margin-bottom: 0.5rem;" id="stat-submissions">0</h3>
                                <p class="text-secondary mb-0">Entregas realizadas</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" style="font-size: 2.5rem; margin-bottom: 0.5rem;" id="stat-reviewed">0</h3>
                                <p class="text-secondary mb-0">Entregas corregidas</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" style="font-size: 2.5rem; margin-bottom: 0.5rem;" id="stat-average">-</h3>
                                <p class="text-secondary mb-0">Nota media</p>
                                <p class="text-secondary" style="font-size: 0.85rem;" id="stat-average-meta">sin calificaciones</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" style="font-size: 2.5rem; margin-bottom: 0.5rem;" id="stat-words">0</h3>
                                <p class="text-secondary mb-0">Palabras escritas</p>
                            </div>
                        </div>
                    </div>

                    <!-- Progreso del curso -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title">Progreso del curso</h3>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Avance general</span>
                                    <span id="progress-percent">0%</span>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <p class="text-secondary">El curso consta de 27 sesiones de 90 minutos, los martes y jueves de febrero a mayo de 2026.</p>
                        </div>
                    </div>

                    <!-- Temas completados -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title">Temas del curso</h3>
                        </div>
                        <div class="card-body">
                            <div id="themes-progress">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Talleres -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title">Talleres obligatorios</h3>
                        </div>
                        <div class="card-body">
                            <div id="workshops-progress">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Historial de actividad -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Actividad reciente</h3>
                        </div>
                        <div class="card-body">
                            <div id="activity-list">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom" style="border:none;padding-top:0;">
                <span>&copy; 2026 Javier Benitez Lainez | CLM - UGR</span>
            </div>
        </div>
    </footer>

    <script>
        window.PE_CONFIG = {
            API_URL: 'https://produccion-escrita-c2-api-production.up.railway.app'
        };
    </script>
    <script src="../js/config.js"></script>
<script src="../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await PE.Auth.checkSession();
            if (!user) {
                const basePath = window.location.pathname.includes('/PE/') ? '/PE' : '';
                window.location.href = basePath + '/auth/login.html';
                return;
            }

            // Obtener estadisticas
            let submissions = await PE.Submissions.getByUser(user.id);
            submissions = Array.isArray(submissions) ? submissions : [];
            const reviewed = submissions.filter(s => s.status === 'reviewed');
            // Nota media "real": usar numericGrade si existe (normalizado a /10 según rúbrica),
            // y si no, mapear la calificación cualitativa a una escala /10.
            let rubricMaxById = {};
            try {
                const needsRubrics = reviewed.some(s => (s.rubricId || s.rubric_id));
                if (needsRubrics) {
                    const rubrics = await PE.API.get('/rubrics');
                    (Array.isArray(rubrics) ? rubrics : []).forEach(r => {
                        if (r && r.id) rubricMaxById[String(r.id)] = parseFloat(r.maxPoints) || 0;
                    });
                }
            } catch (e) {
                console.warn('[Progress] No se pudieron cargar rúbricas para normalizar la nota media:', e?.message || e);
            }

            const qualitativeTo10 = (g) => {
                const v = String(g || '').trim().toLowerCase();
                if (!v) return null;
                if (v === 'excelente') return 9.5;
                if (v === 'muy bien') return 8.5;
                if (v === 'bien') return 7.5;
                if (v === 'suficiente') return 6.0;
                if (v === 'necesita mejorar') return 4.5;
                return null;
            };

            const sumCriterionScores = (scores) => {
                if (!scores || typeof scores !== 'object') return null;
                let total = 0;
                let any = false;
                for (const v of Object.values(scores)) {
                    const n = parseFloat(v);
                    if (!Number.isNaN(n)) {
                        total += n;
                        any = true;
                    }
                }
                return any ? total : null;
            };

            const gradeValue10 = (s) => {
                const numeric = parseFloat(s.numericGrade ?? s.numeric_grade);
                if (!Number.isNaN(numeric)) {
                    const rubricId = s.rubricId ?? s.rubric_id;
                    const maxPoints = rubricId ? (rubricMaxById[String(rubricId)] || 0) : 0;
                    if (maxPoints > 0) {
                        return (numeric / maxPoints) * 10;
                    }
                    return numeric; // asume ya está en escala /10 si no hay info de rúbrica
                }

                // Si no hay numericGrade pero hay criterionScores (rúbrica), sumar y normalizar.
                const rubricId = s.rubricId ?? s.rubric_id;
                const maxPoints = rubricId ? (rubricMaxById[String(rubricId)] || 0) : 0;
                const scoresTotal = sumCriterionScores(s.criterionScores ?? s.criterion_scores);
                if (scoresTotal !== null) {
                    if (maxPoints > 0) return (scoresTotal / maxPoints) * 10;
                    return scoresTotal; // fallback
                }

                const q = qualitativeTo10(s.grade);
                if (q !== null) return q;
                return null;
            };

            const gradedReviewed = reviewed
                .map(s => ({ submission: s, value10: gradeValue10(s) }))
                .filter(x => x.value10 !== null && !Number.isNaN(x.value10));

            const averageGrade = gradedReviewed.length > 0
                ? (gradedReviewed.reduce((sum, x) => sum + x.value10, 0) / gradedReviewed.length)
                : null;
            const totalWords = submissions.reduce((sum, s) => sum + (s.wordCount || 0), 0);

            // Calcular sesiones completadas (basado en fecha actual)
            const courseProgress = PE.CourseData.getCourseProgress();
            const today = PE.CourseData.getTodayDate ? PE.CourseData.getTodayDate() : new Date();

            // Actualizar estadisticas
            document.getElementById('stat-sessions').textContent = courseProgress.completed;
            document.getElementById('stat-submissions').textContent = submissions.length;
            document.getElementById('stat-reviewed').textContent = reviewed.length;
            document.getElementById('stat-average').textContent = averageGrade !== null ? averageGrade.toFixed(1) : '-';
            document.getElementById('stat-average-meta').textContent = gradedReviewed.length > 0
                ? `${gradedReviewed.length} con nota de ${reviewed.length} corregidas`
                : (reviewed.length > 0 ? 'corregidas sin nota' : 'sin calificaciones');
            document.getElementById('stat-words').textContent = totalWords.toLocaleString('es-ES');

            // Barra de progreso
            document.getElementById('progress-percent').textContent = courseProgress.percentage + '%';
            document.getElementById('progress-bar').style.width = courseProgress.percentage + '%';

            // Temas del curso
            const themes = PE.CourseData.themes;
            const themesHtml = themes.map((theme, index) => {
                const isCompleted = index < Math.floor(courseProgress.completed / 2);
                return `
                    <div style="display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="width: 30px; height: 30px; border-radius: 50%; background: ${isCompleted ? 'var(--success-color)' : 'var(--bg-light)'}; display: flex; align-items: center; justify-content: center; margin-right: 1rem; color: ${isCompleted ? 'white' : 'var(--text-secondary)'}; font-size: 0.85rem;">
                            ${isCompleted ? '&#10003;' : index + 1}
                        </span>
                        <span style="flex: 1;">${theme.title}</span>
                        <span class="badge badge-${isCompleted ? 'success' : 'outline'}">${isCompleted ? 'Completado' : 'Pendiente'}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('themes-progress').innerHTML = themesHtml;

            // Talleres
            const workshops = PE.CourseData.workshops;
            const workshopsHtml = workshops.map((workshop, index) => {
                const workshopSession = PE.CourseData.sessions.find(s => s.workshop === workshop.id);
                const workshopDate = workshopSession ? (PE.CourseData.getSessionDate ? PE.CourseData.getSessionDate(workshopSession.date) : new Date(workshopSession.date)) : null;
                const isCompleted = workshopDate && workshopDate < today;
                const hasSubmission = submissions.some(s => s.activityId && s.activityId.includes('taller'));
                return `
                    <div style="display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="width: 30px; height: 30px; border-radius: 50%; background: ${hasSubmission ? 'var(--success-color)' : isCompleted ? 'var(--warning-color)' : 'var(--bg-light)'}; display: flex; align-items: center; justify-content: center; margin-right: 1rem; color: ${hasSubmission || isCompleted ? 'white' : 'var(--text-secondary)'}; font-size: 0.85rem;">
                            ${index + 1}
                        </span>
                        <span style="flex: 1;">${workshop.title}</span>
                        <span class="badge badge-${hasSubmission ? 'success' : isCompleted ? 'warning' : 'outline'}">
                            ${hasSubmission ? 'Entregado' : isCompleted ? 'Realizado' : 'Pendiente'}
                        </span>
                    </div>
                `;
            }).join('');
            document.getElementById('workshops-progress').innerHTML = workshopsHtml;

            // Actividad reciente
            if (submissions.length === 0) {
                document.getElementById('activity-list').innerHTML = `
                    <p class="text-secondary text-center">No hay actividad registrada todavia.</p>
                    <div class="text-center">
                        <a href="../sesiones/index.html" class="btn btn-primary">Ir a las sesiones</a>
                    </div>
                `;
            } else {
                const recentSubmissions = [...submissions].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
                const activityHtml = recentSubmissions.map(s => `
                    <div style="display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 1rem; color: white;">
                            &#9998;
                        </span>
                        <div style="flex: 1;">
                            <p style="margin: 0; font-weight: 500;">${PE.Utils.escapeHtml(s.activityTitle)}</p>
                            <p class="text-secondary" style="margin: 0; font-size: 0.85rem;">${PE.Utils.formatDate(s.createdAt, 'long')}</p>
                        </div>
                        <span class="badge badge-${s.status === 'reviewed' ? 'success' : 'warning'}">
                            ${s.status === 'reviewed' ? 'Corregido' : 'Pendiente'}
                        </span>
                    </div>
                `).join('');
                document.getElementById('activity-list').innerHTML = activityHtml;
            }
        });
    </script>
</body>
</html>
