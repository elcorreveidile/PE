<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi √Årea | Producci√≥n Escrita C2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-main">
            <div class="container">
                <a href="../index.html" class="logo">
                    <div class="logo-icon">C2</div>
                    <div class="logo-text">
                        <span class="logo-title">Producci√≥n Escrita</span>
                        <span class="logo-subtitle">Espa√±ol Avanzado</span>
                    </div>
                </a>
                <nav class="nav-main" id="nav-main">
                    <a href="../index.html">Inicio</a>
                    <a href="../sesiones/index.html">Sesiones</a>
                    <a href="../temas/index.html">Temas</a>
                    <a href="../talleres/index.html">Talleres</a>
                    <a href="../recursos/index.html">Recursos</a>
                </nav>
                <div class="nav-auth"></div>
                <button class="menu-toggle" id="menu-toggle" aria-label="Men√∫">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
    </header>

    <main class="section">
        <div class="container">
            <div class="page-with-sidebar">
                <!-- Sidebar -->
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <div class="text-center mb-3">
                            <div style="width: 80px; height: 80px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 2rem; color: white;" id="user-avatar">
                                E
                            </div>
                            <h3 class="mt-2 mb-0" id="user-name">Estudiante</h3>
                            <span class="badge badge-primary mt-1" id="user-level">Nivel C2</span>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <h4 class="sidebar-title">Navegaci√≥n</h4>
                        <ul class="sidebar-nav">
                            <li><a href="dashboard.html" class="active">Panel principal</a></li>
                            <li><a href="mis-entregas.html">Mis entregas</a></li>
                            <li><a href="progreso.html">Mi progreso</a></li>
                            <li><a href="perfil.html">Mi perfil</a></li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <h4 class="sidebar-title">Accesos r√°pidos</h4>
                        <ul class="sidebar-nav">
                            <li><a href="../sesiones/index.html">Ver sesiones</a></li>
                            <li><a href="../calendario.html">Calendario</a></li>
                            <li><a href="../recursos/index.html">Recursos</a></li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <button onclick="PE.Auth.logout()" class="btn btn-outline btn-block">Cerrar sesi√≥n</button>
                    </div>
                </aside>

                <!-- Contenido principal -->
                <div class="main-content">
                    <h1>Mi √°rea de trabajo</h1>
                    <p class="text-secondary mb-4">Bienvenido/a al curso de Producci√≥n Escrita C2</p>

                    <!-- Resumen del progreso -->
                    <div class="sessions-grid mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" style="font-size: 2.5rem; margin-bottom: 0.5rem;" id="stat-sessions">0</h3>
                                <p class="text-secondary mb-0">Sesiones completadas</p>
                                <div class="progress mt-2">
                                    <div class="progress-bar" id="progress-sessions" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" style="font-size: 2.5rem; margin-bottom: 0.5rem;" id="stat-submissions">0</h3>
                                <p class="text-secondary mb-0">Entregas realizadas</p>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" style="font-size: 2.5rem; margin-bottom: 0.5rem;" id="stat-reviewed">0</h3>
                                <p class="text-secondary mb-0">Con retroalimentaci√≥n</p>
                            </div>
                        </div>
                    </div>

                    <!-- Pr√≥xima sesi√≥n -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 style="margin: 0;">Pr√≥xima sesi√≥n</h3>
                        </div>
                        <div class="card-body" id="next-session">
                            <div class="loader"></div>
                        </div>
                    </div>


                    <!-- Asistencia por QR -->
                    <div class="card mb-4">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">üì± Confirmar asistencia</h3>
                            <span class="badge badge-info" id="attendance-status">Pendiente</span>
                        </div>
                        <div class="card-body">
                            <p class="text-secondary mb-3">Si el profesor ha mostrado el c√≥digo QR o el c√≥digo de verificaci√≥n de 8 caracteres, ingr√©salo aqu√≠.</p>
                            
                            <div id="attendance-form">
                                <div class="form-group">
                                    <label class="form-label">C√≥digo de verificaci√≥n</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input 
                                            type="text" 
                                            id="attendance-code" 
                                            class="form-control" 
                                            placeholder="Ejemplo: ABC12345"
                                            maxlength="8"
                                            style="text-transform: uppercase; font-family: 'JetBrains Mono', monospace; letter-spacing: 0.1em; flex: 1;"
                                        >
                                        <button class="btn btn-primary" onclick="confirmAttendance()">Confirmar</button>
                                    </div>
                                    <small class="text-secondary">Ingresa el c√≥digo de 8 caracteres que mostr√≥ el profesor</small>
                                </div>
                            </div>

                            <div id="attendance-success" style="display: none;" class="alert alert-success">
                                <h4 style="margin: 0 0 0.5rem 0;">‚úÖ Asistencia confirmada</h4>
                                <p style="margin: 0;">Has registrado tu asistencia para el d√≠a de hoy.</p>
                            </div>

                            <div id="attendance-already" style="display: none;" class="alert alert-info">
                                <h4 style="margin: 0 0 0.5rem 0;">‚ÑπÔ∏è Ya registrada</h4>
                                <p style="margin: 0;">Ya tienes registrada tu asistencia de hoy.</p>
                            </div>

                            <div id="attendance-error" style="display: none;" class="alert alert-error">
                                <p style="margin: 0;" id="attendance-error-msg"></p>
                            </div>
                        </div>
                    </div>
                    <!-- Mis entregas recientes -->
                    <div class="card mb-4">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">Mis entregas recientes</h3>
                            <a href="mis-entregas.html" class="btn btn-sm btn-outline">Ver todas</a>
                        </div>
                        <div class="card-body" id="recent-submissions">
                            <div class="loader"></div>
                        </div>
                    </div>

                    <!-- Notificaciones -->
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">Notificaciones</h3>
                            <button class="btn btn-sm btn-outline" onclick="clearOldNotifications()">Limpiar antiguas</button>
                        </div>
                        <div class="card-body" id="notifications-list">
                            <div class="alert alert-info">
                                <div class="alert-content">
                                    <strong>Bienvenido/a al curso</strong>
                                    <p style="margin: 0.5rem 0 0;">El curso comienza el martes 3 de febrero de 2026. Prepara un texto breve en espa√±ol para la primera sesi√≥n.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom" style="border: none; padding-top: 0;">
                <span>Producci√≥n Escrita C2 - Curso 2025-2026</span>
                <a href="../index.html" style="color: rgba(255,255,255,0.7);">Volver al inicio</a>
            </div>
        </div>
    </footer>

    <script>
        window.PE_CONFIG = {
            API_URL: 'https://produccion-escrita-c2-api-production.up.railway.app'
        };
    </script>
    <script src="../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar autenticaci√≥n
            const user = PE.Auth.getCurrentUser();
            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }

            // Actualizar informaci√≥n del usuario
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-avatar').textContent = user.name.charAt(0).toUpperCase();
            document.getElementById('user-level').textContent = user.level || 'C2';

            // Funci√≥n para cargar notificaciones (declarada ANTES de usarla)
            async function loadNotifications() {
                try {
                    const token = PE.Utils?.storage?.get('token') || localStorage.getItem('pe_c2_token');

                    if (!token) {
                        console.warn('No hay token para cargar notificaciones');
                        return;
                    }

                    const response = await fetch(`${window.PE_CONFIG.API_URL}/api/notifications`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        console.warn('Error al cargar notificaciones:', response.status);
                        return;
                    }

                    const data = await response.json();
                    const notifications = data.notifications || [];
                    const container = document.getElementById('notifications-list');

                    if (!container) {
                        console.warn('Contenedor de notificaciones no encontrado');
                        return;
                    }

                    if (notifications.length === 0) {
                        container.innerHTML = `
                            <div class="alert alert-info">
                                <div class="alert-content">
                                    <strong>Bienvenido/a al curso</strong>
                                    <p style="margin: 0.5rem 0 0;">No tienes notificaciones nuevas.</p>
                                </div>
                            </div>
                        `;
                    } else {
                        container.innerHTML = notifications.map(notif => `
                            <div class="alert ${notif.read ? 'alert-secondary' : 'alert-warning'}">
                                <div class="alert-content">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div style="flex: 1; cursor: pointer;" onclick="markAsRead(${notif.id})">
                                            <strong>${PE.Utils.escapeHtml(notif.title)}</strong>
                                            <p style="margin: 0.5rem 0 0; white-space: pre-wrap;">${PE.Utils.escapeHtml(notif.message)}</p>
                                            <div style="margin-top: 0.5rem;">
                                                <small class="text-secondary">${PE.Utils.formatDate(notif.created_at, 'short')}</small>
                                                ${!notif.read ? '<span class="badge badge-warning" style="font-size: 0.75rem; margin-left: 0.5rem;">Nueva</span>' : ''}
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-ghost" onclick="deleteNotification(${notif.id})" style="color: var(--danger-color);" title="Eliminar notificaci√≥n">‚úï</button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Error cargando notificaciones:', error);
                    // Mostrar mensaje por defecto en caso de error
                    const container = document.getElementById('notifications-list');
                    if (container) {
                        container.innerHTML = `
                            <div class="alert alert-info">
                                <div class="alert-content">
                                    <strong>Bienvenido/a al curso</strong>
                                    <p style="margin: 0.5rem 0 0;">No tienes notificaciones nuevas.</p>
                                </div>
                            </div>
                        `;
                    }
                }
            }

            // Marcar notificaci√≥n como le√≠da
            window.markAsRead = async (id) => {
                try {
                    const token = PE.Utils?.storage?.get('token') || localStorage.getItem('pe_c2_token');

                    await fetch(`${window.PE_CONFIG.API_URL}/api/notifications/${id}/read`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    loadNotifications(); // Recargar
                } catch (error) {
                    console.error('Error marcando notificaci√≥n:', error);
                }
            };

            // Eliminar notificaci√≥n
            window.deleteNotification = async (id) => {
                if (!confirm('¬øEst√°s seguro de que quieres eliminar esta notificaci√≥n?')) {
                    return;
                }

                try {
                    const token = PE.Utils?.storage?.get('token') || localStorage.getItem('pe_c2_token');

                    const response = await fetch(`${window.PE_CONFIG.API_URL}/api/notifications/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Error al eliminar notificaci√≥n');
                    }

                    PE.UI.notify('Notificaci√≥n eliminada', 'success');
                    loadNotifications(); // Recargar
                } catch (error) {
                    console.error('Error eliminando notificaci√≥n:', error);
                    PE.UI.notify('Error al eliminar notificaci√≥n', 'error');
                }
            };

            // Limpiar notificaciones antiguas (anteriores al inicio del curso actual)
            window.clearOldNotifications = async () => {
                if (!confirm('¬øEliminar notificaciones anteriores al 2026-02-03?')) {
                    return;
                }

                try {
                    const token = PE.Utils?.storage?.get('token') || localStorage.getItem('pe_c2_token');
                    const response = await fetch(`${window.PE_CONFIG.API_URL}/api/notifications/old?before=2026-02-03`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Error al limpiar notificaciones');
                    }

                    PE.UI.notify(`Notificaciones antiguas eliminadas: ${data.deleted || 0}`, 'success');
                    loadNotifications();
                } catch (error) {
                    console.error('Error limpiando notificaciones antiguas:', error);
                    PE.UI.notify('No se pudieron limpiar las notificaciones antiguas', 'error');
                }
            };

            // Obtener estad√≠sticas
            const progress = PE.CourseData.getCourseProgress();
            let submissions = await PE.Submissions.getByUser(user.id);
            submissions = Array.isArray(submissions) ? submissions : [];
            const reviewed = submissions.filter(s => s.status === 'reviewed');

            document.getElementById('stat-sessions').textContent = progress.completed;
            document.getElementById('progress-sessions').style.width = progress.percentage + '%';
            document.getElementById('stat-submissions').textContent = submissions.length;
            document.getElementById('stat-reviewed').textContent = reviewed.length;

            // Pr√≥xima sesi√≥n
            const nextSession = PE.CourseData.getCurrentSession();
            document.getElementById('next-session').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <span class="badge badge-primary mb-2">Sesi√≥n ${nextSession.id}</span>
                        <h4 style="margin: 0.5rem 0;">${nextSession.title}</h4>
                        <p class="text-secondary mb-0">${nextSession.day}, ${PE.Utils.formatDate(nextSession.date, 'long')}</p>
                    </div>
                    <a href="/sesiones/sesion-${String(nextSession.id).padStart(2, '0')}.html" class="btn btn-primary">
                        Ver sesi√≥n
                    </a>
                </div>
            `;

            // Cargar notificaciones (ahora la funci√≥n ya est√° declarada)
            loadNotifications();

            // Cargar estado de asistencia
            checkAttendanceStatus(user);

            // Entregas recientes
            const recentSubmissions = submissions.slice(-3).reverse();
            const submissionsContainer = document.getElementById('recent-submissions');

            if (recentSubmissions.length === 0) {
                submissionsContainer.innerHTML = `
                    <p class="text-secondary text-center">No has realizado entregas todav√≠a.</p>
                    <p class="text-center">
                        <a href="../sesiones/index.html" class="btn btn-primary">Ir a las sesiones</a>
                    </p>
                `;
            } else {
                submissionsContainer.innerHTML = `
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Actividad</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentSubmissions.map(s => `
                                    <tr>
                                        <td>${PE.Utils.escapeHtml(s.activityTitle)}</td>
                                        <td>${PE.Utils.formatDate(s.createdAt)}</td>
                                        <td>
                                            <span class="badge badge-${s.status === 'reviewed' ? 'success' : 'warning'}">
                                                ${s.status === 'reviewed' ? 'Corregido' : 'Pendiente'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-ghost" onclick="viewSubmission('${s.id}')">Ver</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        });

        // Verificar estado de asistencia
        async function checkAttendanceStatus(currentUser) {
            try {
                const token = PE.Utils?.storage?.get('token') || localStorage.getItem('pe_c2_token');
                const today = new Date().toISOString().split('T')[0];

                if (!token || !currentUser) {
                    return;
                }

                const response = await fetch(`${window.PE_CONFIG.API_URL}/api/attendance/me?date=${today}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const attendance = await response.json();
                    if (attendance?.registered) {
                        // El usuario ya tiene asistencia hoy
                        document.getElementById('attendance-form').style.display = 'none';
                        document.getElementById('attendance-already').style.display = 'block';
                        document.getElementById('attendance-status').textContent = 'Registrada';
                        document.getElementById('attendance-status').className = 'badge badge-success';
                    }
                }
            } catch (error) {
                console.error('Error verificando asistencia:', error);
            }
        }

        // Confirmar asistencia
        window.confirmAttendance = async function() {
            const codeInput = document.getElementById('attendance-code');
            const verificationCode = codeInput.value.trim().toUpperCase();

            if (!verificationCode) {
                document.getElementById('attendance-error').style.display = 'block';
                document.getElementById('attendance-error-msg').textContent = 'Por favor, ingresa el c√≥digo de verificaci√≥n';
                return;
            }

            if (verificationCode.length !== 8) {
                document.getElementById('attendance-error').style.display = 'block';
                document.getElementById('attendance-error-msg').textContent = 'El c√≥digo debe tener 8 caracteres';
                return;
            }

            document.getElementById('attendance-error').style.display = 'none';

            try {
                const token = PE.Utils?.storage?.get('token') || localStorage.getItem('pe_c2_token');

                const response = await fetch(`${window.PE_CONFIG.API_URL}/api/attendance/check-in`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ verificationCode })
                });

                const data = await response.json();

                if (response.ok) {
                    // Asistencia confirmada
                    document.getElementById('attendance-form').style.display = 'none';
                    document.getElementById('attendance-success').style.display = 'block';
                    document.getElementById('attendance-status').textContent = 'Confirmada';
                    document.getElementById('attendance-status').className = 'badge badge-success';
                    PE.UI.notify('Asistencia registrada correctamente', 'success');
                } else {
                    // Error
                    document.getElementById('attendance-error').style.display = 'block';
                    document.getElementById('attendance-error-msg').textContent = data.error || 'Error al confirmar asistencia';
                }
            } catch (error) {
                console.error('Error confirmando asistencia:', error);
                document.getElementById('attendance-error').style.display = 'block';
                document.getElementById('attendance-error-msg').textContent = 'Error de conexi√≥n. Int√©ntalo de nuevo.';
            }
        };

        // Funci√≥n global para ver entrega (accesible desde onclick)
        window.viewSubmission = async function(id) {
            const currentUser = PE.Auth.getCurrentUser();
            if (!currentUser) return;

            let submissions = await PE.Submissions.getByUser(currentUser.id);
            submissions = Array.isArray(submissions) ? submissions : [];
            const targetId = String(id);
            const submission = submissions.find(s => String(s.id) === targetId);

            if (submission) {
                let feedbackHtml = '';
                if (submission.feedback) {
                    feedbackHtml = `
                        <div class="alert alert-success mt-3">
                            <h4>Retroalimentaci√≥n del profesor:</h4>
                            <p>${PE.Utils.escapeHtml(submission.feedback)}</p>
                            ${submission.grade ? `<p><strong>Calificaci√≥n:</strong> ${submission.grade}</p>` : ''}
                        </div>
                    `;
                }

                PE.UI.showModal(submission.activityTitle, `
                    <p class="text-secondary">Entregado: ${PE.Utils.formatDate(submission.createdAt, 'long')}</p>
                    <div style="background: var(--bg-light); padding: 1rem; border-radius: 0.5rem; max-height: 300px; overflow-y: auto;">
                        ${submission.content}
                    </div>
                    <p class="text-secondary mt-2">${submission.wordCount} palabras</p>
                    ${feedbackHtml}
                `, [
                    { text: 'Cerrar' }
                ]);
            }
        };
    </script>
</body>
</html>
