<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Área | Producción Escrita C2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        .qr-container {
            display: inline-block;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            margin: var(--spacing-sm) 0;
        }
        .qr-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
            margin-top: var(--spacing-sm);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-main">
            <div class="container">
                <a href="../index.html" class="logo">
                    <div class="logo-icon">C2</div>
                    <div class="logo-text">
                        <span class="logo-title">Producción Escrita</span>
                        <span class="logo-subtitle">Español Avanzado</span>
                    </div>
                </a>
                <nav class="nav-main" id="nav-main">
                    <a href="../index.html">Inicio</a>
                    <a href="../sesiones/index.html">Sesiones</a>
                    <a href="../temas/index.html">Temas</a>
                    <a href="../talleres/index.html">Talleres</a>
                    <a href="../recursos/index.html">Recursos</a>
                </nav>
                <div class="nav-auth"></div>
                <button class="menu-toggle" id="menu-toggle" aria-label="Menú">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
    </header>

    <main class="section">
        <div class="container">
            <div class="page-with-sidebar">
                <!-- Sidebar -->
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <div class="text-center mb-3">
                            <div style="width: 80px; height: 80px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 2rem; color: white;" id="user-avatar">
                                E
                            </div>
                            <h3 class="mt-2 mb-0" id="user-name">Estudiante</h3>
                            <span class="badge badge-primary mt-1" id="user-level">Nivel C2</span>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <h4 class="sidebar-title">Navegación</h4>
                        <ul class="sidebar-nav">
                            <li><a href="dashboard.html" class="active">Panel principal</a></li>
                            <li><a href="mis-entregas.html">Mis entregas</a></li>
                            <li><a href="progreso.html">Mi progreso</a></li>
                            <li><a href="perfil.html">Mi perfil</a></li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <h4 class="sidebar-title">Accesos rápidos</h4>
                        <ul class="sidebar-nav">
                            <li><a href="../sesiones/index.html">Ver sesiones</a></li>
                            <li><a href="../calendario.html">Calendario</a></li>
                            <li><a href="../recursos/index.html">Recursos</a></li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <button onclick="PE.Auth.logout()" class="btn btn-outline btn-block">Cerrar sesión</button>
                    </div>
                </aside>

                <!-- Contenido principal -->
                <div class="main-content">
                    <h1>Mi área de trabajo</h1>
                    <p class="text-secondary mb-4">Bienvenido/a al curso de Producción Escrita C2</p>

                    <!-- Resumen del progreso -->
                    <div class="sessions-grid mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" style="font-size: 2.5rem; margin-bottom: 0.5rem;" id="stat-sessions">0</h3>
                                <p class="text-secondary mb-0">Sesiones completadas</p>
                                <div class="progress mt-2">
                                    <div class="progress-bar" id="progress-sessions" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" style="font-size: 2.5rem; margin-bottom: 0.5rem;" id="stat-submissions">0</h3>
                                <p class="text-secondary mb-0">Entregas realizadas</p>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary" style="font-size: 2.5rem; margin-bottom: 0.5rem;" id="stat-reviewed">0</h3>
                                <p class="text-secondary mb-0">Con retroalimentación</p>
                            </div>
                        </div>
                    </div>

                    <!-- Mi código QR -->
                    <div class="card mb-4">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">Mi código QR</h3>
                            <span class="badge badge-primary">Identificación</span>
                        </div>
                        <div class="card-body text-center">
                            <p class="text-secondary" style="font-size: 0.875rem;">Tu código QR personal para identificarte en clase</p>
                            <div class="qr-container" id="qr-student"></div>
                            <div class="qr-actions">
                                <button class="btn btn-sm btn-primary" onclick="downloadStudentQR()">Descargar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Próxima sesión -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 style="margin: 0;">Próxima sesión</h3>
                        </div>
                        <div class="card-body" id="next-session">
                            <div class="loader"></div>
                        </div>
                    </div>

                    <!-- Mis entregas recientes -->
                    <div class="card mb-4">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">Mis entregas recientes</h3>
                            <a href="mis-entregas.html" class="btn btn-sm btn-outline">Ver todas</a>
                        </div>
                        <div class="card-body" id="recent-submissions">
                            <div class="loader"></div>
                        </div>
                    </div>

                    <!-- Notificaciones -->
                    <div class="card">
                        <div class="card-header">
                            <h3 style="margin: 0;">Notificaciones</h3>
                        </div>
                        <div class="card-body" id="notifications-list">
                            <div class="alert alert-info">
                                <div class="alert-content">
                                    <strong>Bienvenido/a al curso</strong>
                                    <p style="margin: 0.5rem 0 0;">El curso comienza el martes 3 de febrero de 2026. Prepara un texto breve en español para la primera sesión.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom" style="border: none; padding-top: 0;">
                <span>Producción Escrita C2 - Curso 2025-2026</span>
                <a href="../index.html" style="color: rgba(255,255,255,0.7);">Volver al inicio</a>
            </div>
        </div>
    </footer>

    <script>
        window.PE_CONFIG = {
            API_URL: 'https://produccion-escrita-c2-api-production.up.railway.app'
        };
    </script>
    <script src="../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar autenticación
            const user = PE.Auth.getCurrentUser();
            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }

            // Actualizar información del usuario
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-avatar').textContent = user.name.charAt(0).toUpperCase();
            document.getElementById('user-level').textContent = user.level || 'C2';

            // Obtener estadísticas
            const progress = PE.CourseData.getCourseProgress();
            let submissions = await PE.Submissions.getByUser(user.id);
            submissions = Array.isArray(submissions) ? submissions : [];
            const reviewed = submissions.filter(s => s.status === 'reviewed');

            document.getElementById('stat-sessions').textContent = progress.completed;
            document.getElementById('progress-sessions').style.width = progress.percentage + '%';
            document.getElementById('stat-submissions').textContent = submissions.length;
            document.getElementById('stat-reviewed').textContent = reviewed.length;

            // Próxima sesión
            const nextSession = PE.CourseData.getCurrentSession();
            document.getElementById('next-session').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <span class="badge badge-primary mb-2">Sesión ${nextSession.id}</span>
                        <h4 style="margin: 0.5rem 0;">${nextSession.title}</h4>
                        <p class="text-secondary mb-0">${nextSession.day}, ${PE.Utils.formatDate(nextSession.date, 'long')}</p>
                    </div>
                    <a href="../sesiones/sesion-${String(nextSession.id).padStart(2, '0')}.html" class="btn btn-primary">
                        Ver sesión
                    </a>
                </div>
            `;

            // Generar QR del estudiante
            if (typeof QRCode !== 'undefined') {
                const basePath = window.location.pathname.includes('/PE/') ? '/PE' : '';
                const profileUrl = window.location.origin + basePath + '/usuario/perfil.html?id=' + user.id;
                const qrContainer = document.getElementById('qr-student');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: profileUrl,
                    width: 150,
                    height: 150,
                    colorDark: '#1a1a2e',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }

            // Entregas recientes
            const recentSubmissions = submissions.slice(-3).reverse();
            const submissionsContainer = document.getElementById('recent-submissions');

            if (recentSubmissions.length === 0) {
                submissionsContainer.innerHTML = `
                    <p class="text-secondary text-center">No has realizado entregas todavía.</p>
                    <p class="text-center">
                        <a href="../sesiones/index.html" class="btn btn-primary">Ir a las sesiones</a>
                    </p>
                `;
            } else {
                submissionsContainer.innerHTML = `
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Actividad</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentSubmissions.map(s => `
                                    <tr>
                                        <td>${PE.Utils.escapeHtml(s.activityTitle)}</td>
                                        <td>${PE.Utils.formatDate(s.createdAt)}</td>
                                        <td>
                                            <span class="badge badge-${s.status === 'reviewed' ? 'success' : 'warning'}">
                                                ${s.status === 'reviewed' ? 'Corregido' : 'Pendiente'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-ghost" onclick="viewSubmission('${s.id}')">Ver</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        });

        function downloadStudentQR() {
            const container = document.getElementById('qr-student');
            const canvas = container.querySelector('canvas');
            if (!canvas) return;

            const user = PE.Auth.getCurrentUser();
            const link = document.createElement('a');
            link.download = 'qr-estudiante-' + (user ? user.name.replace(/\s+/g, '-').toLowerCase() : 'pe-c2') + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        async function viewSubmission(id) {
            const currentUser = PE.Auth.getCurrentUser();
            if (!currentUser) return;

            let submissions = await PE.Submissions.getByUser(currentUser.id);
            submissions = Array.isArray(submissions) ? submissions : [];
            const targetId = String(id);
            const submission = submissions.find(s => String(s.id) === targetId);

            if (submission) {
                let feedbackHtml = '';
                if (submission.feedback) {
                    feedbackHtml = `
                        <div class="alert alert-success mt-3">
                            <h4>Retroalimentación del profesor:</h4>
                            <p>${PE.Utils.escapeHtml(submission.feedback)}</p>
                            ${submission.grade ? `<p><strong>Calificación:</strong> ${submission.grade}</p>` : ''}
                        </div>
                    `;
                }

                PE.UI.showModal(submission.activityTitle, `
                    <p class="text-secondary">Entregado: ${PE.Utils.formatDate(submission.createdAt, 'long')}</p>
                    <div style="background: var(--bg-light); padding: 1rem; border-radius: 0.5rem; max-height: 300px; overflow-y: auto;">
                        ${submission.content}
                    </div>
                    <p class="text-secondary mt-2">${submission.wordCount} palabras</p>
                    ${feedbackHtml}
                `, [
                    { text: 'Cerrar' }
                ]);
            }
        }
    </script>
</body>
</html>
